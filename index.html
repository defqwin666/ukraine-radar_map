<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ukraine Radar Map ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞ –∫–æ–ø—ñ—è (–∑ –≤—Ö–æ–¥–æ–º)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- html2canvas (—Å–∫—Ä—ñ–Ω—à–æ—Ç) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#0f0f10;
      --panel:#17171a;
      --panel2:#1f1f24;
      --stroke:#ffffff;
      --muted:#b8b8c5;
      --line:#2b2b33;
      --btn:#23232a;
      --btnH:#2c2c36;
      --danger:#ff4d4d;
      --warn:#ffd54a;
      --ok:#49d17d;
      --cyan:#6fe3ff;
      --shadow: 0 10px 40px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; height:100vh; background:var(--bg); color:var(--stroke);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      display:grid; grid-template-columns: 380px 1fr;
    }
    #left{
      border-right:1px solid var(--line);
      background:linear-gradient(180deg,var(--panel),#121216);
      padding:12px; overflow:auto;
    }
    #mapWrap{ position:relative; height:100vh; }
    #map{ height:100%; width:100%; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:8px 10px; border:1px solid var(--line); border-radius:14px;
      background:rgba(255,255,255,0.03);
      box-shadow: var(--shadow);
      margin-bottom:10px;
    }
    .title{ font-weight:900; font-size:14px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      background:var(--btn); color:var(--stroke);
      border:1px solid #31313a;
      padding:10px 10px; border-radius:12px;
      cursor:pointer; user-select:none;
      font-weight:800; font-size:13px;
    }
    .btn:hover{ background:var(--btnH); }
    .btn.small{ padding:8px 10px; font-size:12px; font-weight:800; border-radius:11px; }
    .btn.danger{ background:#2a1616; border-color:#5b2a2a; }
    .btn.danger:hover{ background:#351a1a; }
    .btn.ok{ background:#132318; border-color:#1f4a2f; }
    .btn.ok:hover{ background:#16301f; }
    .btn.active{ outline:2px solid rgba(111,227,255,.35); }
    .tabs{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap:8px; margin-bottom:10px;
    }
    .tab{
      text-align:center; padding:10px 8px; border-radius:12px;
      border:1px solid var(--line); background:rgba(255,255,255,.02);
      font-weight:900; cursor:pointer;
    }
    .tab.active{ outline:2px solid rgba(111,227,255,.35); background:rgba(111,227,255,.08); }
    .card{
      background:rgba(255,255,255,0.03);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      box-shadow: var(--shadow);
      margin-bottom:10px;
    }
    label{ font-size:12px; color:var(--muted); display:block; margin:10px 0 6px; }
    input, select{
      width:100%;
      background:var(--panel2);
      border:1px solid #343443;
      color:var(--stroke);
      padding:10px;
      border-radius:12px;
      outline:none;
      font-size:14px;
    }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; }
    .hint{ color:var(--muted); font-size:12px; line-height:1.35; }
    .hr{ height:1px; background:var(--line); margin:10px 0; }
    .list{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(0,0,0,0.24);
    }
    .itemTop{ display:flex; justify-content:space-between; align-items:flex-start; gap:8px; }
    .itemTitle{ font-weight:1000; font-size:14px; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:11px; padding:5px 9px; border-radius:999px;
      border:1px solid #3a3a44; color:var(--muted);
      background:rgba(255,255,255,0.03);
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:50%; display:inline-block; }
    .dot.ok{ background:var(--ok); }
    .dot.warn{ background:var(--warn); }
    .dot.danger{ background:var(--danger); }
    .dot.acoustic{ background:var(--cyan); }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .pillRow{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,0.06);
      border:1px solid var(--line);
      font-size:12px; color:var(--muted);
      user-select:none;
    }
    .toggle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px; border-radius:14px;
      border:1px solid var(--line); background:rgba(255,255,255,0.02);
      margin-top:8px;
    }
    .toggle b{ font-size:13px; }
    .toggle small{ display:block; color:var(--muted); font-size:12px; margin-top:2px; }
    .switch{
      width:46px; height:26px; border-radius:999px;
      background:#2a2a33; border:1px solid #3a3a46;
      position:relative; cursor:pointer; flex:0 0 auto;
    }
    .switch::after{
      content:""; width:20px; height:20px; border-radius:50%;
      background:#fff; position:absolute; top:50%; left:3px;
      transform:translateY(-50%); transition: all .15s ease;
    }
    .switch.on{ background:rgba(73,209,125,.25); border-color:rgba(73,209,125,.5); }
    .switch.on::after{ left:23px; }
    /* Map overlays */
    #crosshair{
      position:absolute; inset:0; pointer-events:none; display:none;
    }
    #crosshair svg{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
    #watermark{
      position:absolute; inset:0; pointer-events:none; display:none;
      opacity:0.2;
    }
    #announce{
      position:absolute; left:12px; right:12px; bottom:12px;
      display:none;
      background:rgba(0,0,0,0.55);
      border:1px solid rgba(255,255,255,0.12);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      box-shadow: var(--shadow);
      font-weight:800;
    }
    #fps{
      position:absolute; right:10px; bottom:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size:12px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,0.12);
      padding:6px 10px; border-radius:12px;
      display:none; pointer-events:none;
    }
    /* Modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      z-index:9999;
      padding:14px;
    }
    .modal{
      width:min(920px, 100%);
      background:linear-gradient(180deg,#17171a,#0f0f12);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-bottom:1px solid var(--line);
    }
    .modalTop b{ font-size:14px; }
    .modalBody{ padding:12px; }
    .closeX{ cursor:pointer; font-weight:1000; padding:6px 10px; border-radius:10px; border:1px solid var(--line); background:rgba(255,255,255,0.02); }
    .closeX:hover{ background:rgba(255,255,255,0.05); }
    #shotImg{ width:100%; border-radius:14px; border:1px solid var(--line); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; }
  
    table.tbl{width:100%;border-collapse:collapse;}
    table.tbl th,table.tbl td{padding:10px;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap;}

.dropdown{
  position:relative;
  background:#14161a;
  border:1px solid rgba(255,255,255,.08);
  border-radius:12px;
  padding:6px;
  margin-top:6px;
  max-height:220px;
  overflow:auto;
}
.dropdown .item{
  padding:8px 10px;
  border-radius:10px;
  cursor:pointer;
}
.dropdown .item:hover{ background:rgba(255,255,255,.06); }
.dropdown .small{ font-size:12px; opacity:.8; display:block; }
.avatarMarker{
  width:36px;height:36px;border-radius:50%;
  display:grid;place-items:center;
  border:2px solid rgba(255,255,255,.35);
  box-shadow:0 6px 18px rgba(0,0,0,.45);
  overflow:hidden;
  background:rgba(0,0,0,.35);
}
.avatarMarker img{ width:100%; height:100%; object-fit:cover; display:block; }
.avatarLabel{
  margin-top:4px;
  padding:2px 6px;
  border-radius:10px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.14);
  font-size:12px;
  white-space:nowrap;
}


  .banOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.78);z-index:99999;}
  .banCard{width:min(520px,92vw);background:#2b2b2b;border-radius:22px;box-shadow:0 20px 60px rgba(0,0,0,.55);padding:26px 22px;text-align:center;border:1px solid rgba(255,255,255,.08);}
  .banIcon{width:64px;height:64px;border-radius:50%;margin:0 auto 14px;background:#ff4d6d;display:flex;align-items:center;justify-content:center;font-size:30px;color:#fff;box-shadow:0 0 22px rgba(255,77,109,.35);}
  .banTitle{font-weight:900;letter-spacing:.5px;font-size:30px;color:#ff3b3b;margin-top:6px;}
  .banSub{margin-top:6px;font-size:14px;opacity:.9}
  .banReasonBox{margin:18px auto 16px;border:1px solid rgba(255,59,59,.8);border-radius:14px;padding:12px;background:rgba(0,0,0,.15);}
  .banReasonLabel{font-size:11px;letter-spacing:.8px;color:#ff6b6b;font-weight:900;margin-bottom:6px;}
  .banReasonText{font-size:14px;color:#fff;white-space:pre-wrap}
  .banBtn{margin-top:6px;border:none;border-radius:18px;background:#ffffff;color:#000;font-weight:900;padding:12px 18px;cursor:pointer;min-width:200px;}


/* Top action buttons on map */
#topActions{position:absolute;top:14px;left:14px;z-index:1200;display:flex;gap:10px;align-items:center}
.topBtn{width:44px;height:44px;border-radius:12px;border:1px solid rgba(0,0,0,.15);background:#fff;color:#111;
  font-weight:1000;font-size:26px;line-height:44px;text-align:center;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,.20)}
.topBtn.smallText{width:auto;padding:0 14px;font-size:14px}

.topBtn.active{outline:3px solid rgba(0,140,255,.55); box-shadow:0 10px 30px rgba(0,0,0,.25), 0 0 0 3px rgba(0,140,255,.25) inset;}
#drawHud{position:absolute;top:68px;left:14px;z-index:1200;display:none;gap:8px;align-items:center;background:rgba(255,255,255,.92);
  border-radius:14px;border:1px solid rgba(0,0,0,.12);padding:10px 10px;box-shadow:0 10px 30px rgba(0,0,0,.20)}
#drawHud .mini{height:34px;border-radius:12px;border:1px solid rgba(0,0,0,.15);background:#fff;color:#111;font-weight:900;padding:0 10px;cursor:pointer}
#drawHud .swatch{width:34px;height:34px;border-radius:12px;border:1px solid rgba(0,0,0,.15);cursor:pointer}

.topBtn.active{background:#e8f0ff;border-color:rgba(0,60,255,.35)}
/* Hide/show left panel */
body.panelHidden #sidebar{transform:translateX(-110%);pointer-events:none}
body.panelHidden #mapWrap{margin-left:0}
#sidebar{transition:transform .22s ease}
/* Target action menu */
#targetMenu{position:absolute;z-index:1300;min-width:240px;max-width:280px;
  background:rgba(25,25,25,.92);backdrop-filter: blur(10px);
  border:1px solid rgba(255,255,255,.10);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.50);
  padding:12px;display:none;color:#fff}
#targetMenu .title{font-weight:1000;margin-bottom:8px}
#targetMenu .btnRow{display:flex;gap:8px;flex-wrap:wrap}
#targetMenu button{cursor:pointer;border:none;border-radius:12px;padding:10px 10px;font-weight:800;
  background:rgba(255,255,255,.10);color:#fff}
#targetMenu button:hover{background:rgba(255,255,255,.16)}
#targetMenu button.danger{background:rgba(255,75,75,.18)}
#targetMenu button.danger:hover{background:rgba(255,75,75,.28)}
#targetMenu .mini{font-size:12px;opacity:.85;margin:6px 0 10px}
#targetMenu .sep{height:1px;background:rgba(255,255,255,.12);margin:10px 0}
#toast{position:absolute;z-index:1400;left:50%;top:14px;transform:translateX(-50%);
  background:rgba(0,0,0,.72);color:#fff;padding:10px 14px;border-radius:14px;display:none;font-weight:800}

</style>

<style id="authStyle">
  .authOverlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter: blur(8px);display:none;align-items:center;justify-content:center;z-index:99999}
  .authCard{width:min(520px,92vw);background:#0e1116;border:1px solid rgba(255,255,255,.14);border-radius:18px;padding:18px 18px 16px;color:#e9eef5;box-shadow:0 20px 60px rgba(0,0,0,.55)}
  .authTitle{font-weight:800;font-size:20px;margin:0 0 6px}
  .authSub{opacity:.8;font-size:13px;margin:0 0 14px;line-height:1.35}
  .authRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .authRow input{flex:1;min-width:220px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:#121824;color:#e9eef5;outline:none}
  .authRow button{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:#1dd27a;color:#062012;font-weight:800;cursor:pointer}
  .authMsg{margin-top:10px;font-size:13px;opacity:.9}
  .authMsg.bad{color:#ff7b7b}
  .authMsg.ok{color:#7bffb3}
  .authMini{position:absolute;top:10px;right:12px;display:flex;gap:8px;align-items:center;font-size:12px;opacity:.85}
  .authMini button{padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#10141a;color:#e9eef5;cursor:pointer}
</style>

</head>

<body>

<div id="authOverlay" class="authOverlay">
  <div class="authCard">
    <div class="authMini">
      <span id="authStatusMini">–Ω–µ —É–≤—ñ–π—à–æ–≤</span>
      <button id="authReloadBtn" type="button">–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
    </div>
    <p class="authTitle">–í—Ö—ñ–¥ –≤ –∞–∫–∞—É–Ω—Ç</p>
    <p class="authSub">–í–≤–µ–¥–∏ <b>–ø–æ—à—Ç—É</b> —Ç–∞ <b>–∫–æ–¥</b>, —è–∫–∏–π —Ç–∏ –∑–≥–µ–Ω–µ—Ä—É–≤–∞–≤ –≤ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ. (–í—Ö—ñ–¥ –ø–æ—Ç—Ä—ñ–±–µ–Ω —Ç—ñ–ª—å–∫–∏ –¥–ª—è –º–∞–ø–∏.)</p>
    <div class="authRow" style="margin-bottom:10px">
      <input id="authEmail" placeholder="–ü–æ—à—Ç–∞ " autocomplete="off" />
    </div>
    <div class="authRow">
      <input id="authKey" placeholder="–ö–æ–¥ / –∫–ª—é—á..." autocomplete="off" />
      <button id="authLoginBtn" type="button">–£–≤—ñ–π—Ç–∏</button>
    </div>
    <div class="authHelp">–ö–æ–¥–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ (localStorage). –©–æ–± —ñ–Ω—à—ñ –ª—é–¥–∏ –º–æ–≥–ª–∏ –≤—Ö–æ–¥–∏—Ç–∏, –≤—ñ–¥–∫—Ä–∏–≤–∞–π –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å —ñ –º–∞–ø—É –Ω–∞ <b>—Ç–æ–º—É –∂ –¥–æ–º–µ–Ω—ñ</b> (–æ–¥–∏–Ω —ñ —Ç–æ–π –∂–µ —Å–∞–π—Ç).</div>
    <div id="authMsg" class="authMsg"></div>
  </div>
</div>


<div id="banOverlay" class="banOverlay" style="display:none;">
  <div class="banCard">
    <div class="banIcon">‚õî</div>
    <div class="banTitle">–î–û–°–¢–£–ü –ó–ê–ë–û–†–û–ù–ï–ù–û</div>
    <div class="banSub">–í–∞—à –∞–∫–∞—É–Ω—Ç –±—É–ª–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ü—ñ—î—é.</div>

    <div class="banReasonBox">
      <div class="banReasonLabel">–ü–†–ò–ß–ò–ù–ê –ë–õ–û–ö–£–í–ê–ù–ù–Ø</div>
      <div id="banReasonText" class="banReasonText">‚Äî</div>
    </div>

    <button id="banLogoutBtn" class="banBtn" type="button">–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É</button>
  </div>
</div>


<aside id="left">
    <div class="topbar">
      <div>
        <div class="title">Ukraine Radar Map ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ</div>
        <div class="sub">–∑ –≤—Ö–æ–¥–æ–º ‚Ä¢ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –±—Ä–∞—É–∑–µ—Ä—ñ ‚Ä¢ –µ–∫—Å–ø–æ—Ä—Ç/—ñ–º–ø–æ—Ä—Ç</div>
      </div>
      <div class="row">
        <button class="btn small" id="btnShot">üì∏</button>
        <button class="btn small" id="btnExport">‚¨áÔ∏è</button>
        <button class="btn small" id="btnImport">‚¨ÜÔ∏è</button>
        <input id="file" type="file" accept="application/json" style="display:none" />
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="targets">–¶—ñ–ª—ñ</div>
<div class="tab" data-tab="settings">‚öôÔ∏è</div>
            <div class="tab" data-tab="tools">–Ü–Ω—Å—Ç—Ä—É–º.</div>
</div>
    </div>

    <!-- TARGETS TAB -->
    <section class="tabPane" id="tab-targets">
      <div class="card">
        <div class="row">
          <button class="btn ok" id="btnAdd">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ü—ñ–ª—å</button>
          <button class="btn" id="btnCenter">üéØ –¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
          <button class="btn danger" id="btnClear">üóë –û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>

        <div class="hr"></div>

        <div class="grid2">
          <div>
            <label>–¢–∏–ø —Ü—ñ–ª—ñ</label>
            <select id="type">
                            <option>–¢–∞–∫—Ç–∏—á–Ω–∞ –∞–≤—ñ–∞—Ü—ñ—è/–¢–ê</option>
              <option>–ù–µ–≤—Å. –¶—ñ–ª—å</option>
<option>–®–∞—Ö–µ–¥</option>
              <option>–ë–ø–õ–ê</option>
              <option>–•-59</option>
              <option>–•-101</option>
              <option>–†–æ–∑–≤—ñ–¥–Ω–∏–∫</option>
              <option>–°-300–ü–ü</option>
              <option>–ö–ê–ë</option>
              <option>–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ö</option>
              <option>–ü–£ –†–°–ó–í</option>
              <option>–ü–£ –Ü—Å–∫–∞–Ω–¥–µ—Ä</option>
              <option>–ë–∞–ª—ñ—Å—Ç–∏–∫–∞</option>
              <option>–ú—ñ–ì-31–ö</option>
              <option>FPV</option>
              <option>–ù–µ–≤—ñ–¥–æ–º–∏–π</option>
              <option>–ú–æ–ª–Ω—ñ—è</option>
              <option>–õ–∞–Ω—Ü–µ—Ç</option>
              <option>–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ú</option>
              <option>–†–°–ó–í</option>
              <option>–¢–ê</option>
              <option>–ö–∏–Ω–∂–∞–ª</option>
              <option>–¢—É-22</option>
              <option>–•-22</option>
              <option>–¢—É-95–ú–°</option>
              <option>–•-31</option>
              <option>–£–¥–∞—Ä–Ω–∏–π/—Ä–æ–∑–≤—ñ–¥ –ë–ø–õ–ê</option>
              <option>–®–≤–∏–¥–∫—ñ—Å–Ω–∞</option>
              <option>–Ü—Ç–∞–ª–º–∞—Å</option>
              <option>–®–∞—Ö–µ–¥ 238</option>
              <option>–û—Ä–ª–∞–Ω-10</option>
              <option>–°—É–ø–µ—Ä–∫–∞–º</option>
              <option>–ó–∞–ª–∞</option>
              <option>–°—É-57</option>
              <option>–ì–µ—Ä–±–µ—Ä–∞</option>
              <option>–ü—ñ–¥–ª–æ–¥–∫–∞</option>
              <option>–ö–æ—Ä–∞–±–µ–ª—å</option>
              <option>–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è</option>
              <option>–ù–µ–≤—Å—Ç. —Ü—ñ–ª—å</option>
              <option>–¢—É-160</option>
              <option>–Ü–ª-78–ú</option>
              <option>–ö–∞–ª—ñ–±—Ä</option>
              <option>–û—Ä—ñ–æ–Ω</option>
              <option>–•-69</option>
              <option>–ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ –∫—É–ª—è</option>
              <option>–ì–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä</option>
              <option>–Ø—Ä—Å/–û—Ä—î—à–Ω–∏–∫</option>
              <option>–®–∞—Ö–µ–¥ (–í–ü)</option>
              <option>–ì–µ—Ä–∞–Ω—å-5</option>
              <option>–†–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä</option>
              <option>–ë–ú-35</option>
              <option>–°—É-34</option>
              <option>–ê–Ω-26</option>
            </select>
          </div>
          <div>
            <label>–°—Ç–∞—Ç—É—Å</label>
            <select id="status">
              <option value="move">–†—É—Ö</option>
              <option value="threat">–ó–∞–≥—Ä–æ–∑–∞</option>
              <option value="acoustic">–ê–∫—É—Å—Ç–∏–∫–∞</option>
              <option value="acousticThreat">–ê–∫—É—Å—Ç. –∑–∞–≥—Ä–æ–∑–∞</option>
              <option value="stop">–°—Ç–æ–ø</option>
            </select>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>–ù–∞–∑–≤–∞</label>
            <input id="name" placeholder="–ù–∞–ø—Ä: Shahed-1" />
          </div>
          <div>
            <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</label>
            <input id="count" type="number" min="1" step="1" value="1" />
          </div>
        </div>

        <div class="grid3">
          <div>
            <label>–®–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥)</label>
            <input id="speed" type="number" min="0" step="1" value="150" />
          </div>
          <div>
            <label>–î–∞–ª—å–Ω—ñ—Å—Ç—å (–∫–º)</label>
            <input id="rangeKm" type="number" min="0" step="1" value="999" />
          </div>
          <div>
            <label>–ö—É—Ä—Å (¬∞)</label>
            <input id="heading" type="number" min="0" max="359" step="1" value="90" />
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>–†–∞–¥—ñ—É—Å –∑–∞–≥—Ä–æ–∑–∏ (–∫–º)</label>
            <input id="threatRadius" type="number" min="0" step="1" value="25" />
          </div>
          <div>
            <label>–ö—É—Ç –∑–∞–≥—Ä–æ–∑–∏ (¬∞)</label>
            <input id="threatAngle" type="number" min="0" max="360" step="1" value="90" />
          </div>
        </div>

        <div class="hint" style="margin-top:10px;">
          –ù–∞—Ç–∏—Å–Ω–∏ <b>‚Äú–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ü—ñ–ª—å‚Äù</b>, –ø–æ—Ç—ñ–º –∫–ª–∞—Ü–Ω–∏ –ø–æ –º–∞–ø—ñ. –î–∞–ª—ñ: —Ç–∞–ø –ø–æ –º–∞—Ä–∫–µ—Ä—É ‚Üí –º–µ–Ω—é (–ø–∞—É–∑–∞/—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è/–Ω–∞–ø—Ä—è–º–æ–∫/–∫–ª–æ–Ω/–≤–∏–¥–∞–ª–∏—Ç–∏).
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div class="title">–°–ø–∏—Å–æ–∫ —Ü—ñ–ª–µ–π</div>
          <div class="row">
            <button class="btn small active" id="filterMine">–ú–æ—ó</button>
            <button class="btn small" id="filterForeign">–ß—É–∂—ñ</button>
          </div>
        </div>
        <div class="list" id="list"></div>
      </div>
    </section>

    
    <!-- SETTINGS TAB -->
    <section class="tabPane" id="tab-settings" style="display:none;">
      <div class="card">
        <div class="title">–í–∏–≥–ª—è–¥</div>

        <div class="toggle">
          <div>
            <b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∑–Ω–∞—á–∫–∏ —Å—Ç–∞—Ç—É—Å—ñ–≤</b>
            <small>–†—É—Ö / –ó–∞–≥—Ä–æ–∑–∞ / –ê–∫—É—Å—Ç–∏–∫–∞ / –ê–∫—É—Å—Ç. –∑–∞–≥—Ä–æ–∑–∞</small>
          </div>
          <div class="switch on" id="swStatusIcons"></div>
        </div>

        <div class="toggle">
          <div><b>–ó–∞–±—Ä–∞—Ç–∏ –∑–æ–Ω–∏ –ø–µ—Ä–µ–¥ —Ü—ñ–ª–ª—é</b><small>—Ö–æ–≤–∞—î —Å–µ–∫—Ç–æ—Ä (–∑–æ–Ω—É) –ø–µ—Ä–µ–¥ —Ü—ñ–ª–ª—é</small></div>
          <div class="switch" id="swHideThreats"></div>
        </div>


        <div class="toggle">
          <div><b>–õ—ñ–Ω—ñ—è —Ñ—Ä–æ–Ω—Ç—É</b><small>–ø–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏</small></div>
          <div class="switch" id="swFrontLine"></div>
        </div>

        <div class="toggle">
          <div><b>–û–∫—É–ø–æ–≤–∞–Ω—ñ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—ó</b><small>–∑–∞–ª–∏–≤–∫–∞ –Ω–∞ –º–∞–ø—ñ</small></div>
          <div class="switch" id="swOccupied"></div>
        </div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç–æ–≤—É –æ–±'—è–≤—É</b><small>—Ç–µ–∫—Å—Ç –≤–Ω–∏–∑—É –Ω–∞ –º–∞–ø—ñ</small></div>
          <div class="switch" id="swAnnounce"></div>
        </div>

        <label>–¢–µ–∫—Å—Ç –Ω–∞ –∫–∞—Ä—Ç—ñ</label>
        <input id="announceText" placeholder="–¢–ï–ö–°–¢ –ù–ê –ö–ê–†–¢–Ü" />

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ç–æ—á–∫–∏ –ø–æ–≤–æ—Ä–æ—Ç—É</b><small>–¥–ª—è —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó —Ü—ñ–ª—ñ</small></div>
          <div class="switch" id="swTurnPoints"></div>
        </div>

        <div class="toggle">
          <div><b>–ë—ñ–ª–∞ –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ —ñ–∫–æ–Ω–æ–∫</b><small>—Å–≤—ñ—Ç—ñ–Ω–Ω—è –Ω–∞–≤–∫–æ–ª–æ –º–∞—Ä–∫–µ—Ä—ñ–≤</small></div>
          <div class="switch" id="swGlow"></div>
        </div>

        <div class="toggle">
          <div><b>–î–∏–Ω–∞–º—ñ—á–Ω–∏–π —Ä–æ–∑–º—ñ—Ä (–ó—É–º)</b><small>–º–∞—Å—à—Ç–∞–± —ñ–∫–æ–Ω–æ–∫ –≤—ñ–¥ –∑—É–º—É</small></div>
          <div class="switch on" id="swDynSize"></div>
        </div>

        <div class="hr"></div>

        <label>–ö–æ–ª—ñ—Ä —ñ–∫–æ–Ω–∫–∏</label>
        <input id="iconColor" type="color" value="#ffffff" />

        <label>–†–æ–∑–º—ñ—Ä —ñ–∫–æ–Ω–∫–∏</label>
        <input id="iconSize" type="number" min="18" step="1" value="30" />

        <label>–ö–æ–ª—ñ—Ä –ø—ñ–¥–ø–∏—Å—É</label>
        <input id="labelColor" type="color" value="#ffffff" />

        <label>–ö–æ–ª—ñ—Ä —Ñ–æ–Ω—É –Ω–∞–∑–≤</label>
        <input id="labelBg" type="color" value="#000000" />

        <label>–†–æ–∑–º—ñ—Ä –ø—ñ–¥–ø–∏—Å—É</label>
        <input id="labelSize" type="number" min="8" step="1" value="12" />

        <div class="toggle">
          <div><b>–§–æ–Ω –¥–ª—è –Ω–∞–∑–≤</b><small>–ø—ñ–¥–∫–ª–∞–¥–∫–∞ –ø—ñ–¥ –Ω–∞–∑–≤–æ—é</small></div>
          <div class="switch on" id="swLabelBg"></div>
        </div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –Ω–∞–∑–≤–∏</b><small>—Ö–æ–≤–∞—î/–ø–æ–∫–∞–∑—É—î –ø—ñ–¥–ø–∏—Å</small></div>
          <div class="switch on" id="swLabels"></div>
        </div>
      </div>

      <div class="card">
        <div class="title">–ü—Ä–∏—Ü—ñ–ª (—Ü–µ–Ω—Ç—Ä –µ–∫—Ä–∞–Ω—É)</div>
        <div class="toggle">
          <div><b>–£–≤—ñ–º–∫–Ω—É—Ç–∏ –ø—Ä–∏—Ü—ñ–ª</b><small>–≤ —Ü–µ–Ω—Ç—Ä—ñ –º–∞–ø–∏</small></div>
          <div class="switch" id="swCrosshair"></div>
        </div>

        <label>–¢–∏–ø –ø—Ä–∏—Ü—ñ–ª—É</label>
        <select id="crosshairType">
          <option value="1">–í–∞—Ä—ñ–∞–Ω—Ç 1</option>
          <option value="2">–í–∞—Ä—ñ–∞–Ω—Ç 2</option>
          <option value="3">–í–∞—Ä—ñ–∞–Ω—Ç 3</option>
        </select>

        <div class="grid2">
          <div>
            <label>–ö–æ–ª—ñ—Ä</label>
            <input id="crosshairColor" type="color" value="#ffffff" />
          </div>
          <div>
            <label>–†–æ–∑–º—ñ—Ä (px)</label>
            <input id="crosshairSize" type="number" min="20" step="1" value="60" />
          </div>
        </div>

        <label>–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å</label>
        <input id="crosshairOpacity" type="range" min="0" max="1" step="0.05" value="0.7" />
      </div>

      <div class="card">
        <div class="title">–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è (ID)</div>
        <label>–†–µ–∂–∏–º</label>
        <select id="idMode">
          <option value="random">–í–∏–ø–∞–¥–∫–æ–≤—ñ</option>
          <option value="seq">–ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ</option>
        </select>

        <div class="grid2">
          <div>
            <label>–î—ñ–∞–ø–∞–∑–æ–Ω (–≤—ñ–¥)</label>
            <input id="idFrom" type="number" value="1000" />
          </div>
          <div>
            <label>–î—ñ–∞–ø–∞–∑–æ–Ω (–¥–æ)</label>
            <input id="idTo" type="number" value="9999" />
          </div>
        </div>

        <label>–°—É—Ñ—ñ–∫—Å</label>
        <input id="idSuffix" placeholder="–ù–∞–ø—Ä: A" />

        <div class="grid2">
          <div>
            <label>–ö–æ–ª—ñ—Ä ID</label>
            <input id="idColor" type="color" value="#ffffff" />
          </div>
          <div>
            <label>–†–æ–∑–º—ñ—Ä ID</label>
            <input id="idSize" type="number" value="12" />
          </div>
        </div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ ID</b><small>–Ω–∞–¥ —Ü—ñ–ª–ª—é</small></div>
          <div class="switch" id="swShowId"></div>
        </div>
      </div>

      <div class="card">
        <div class="title">–ö–∞—Ä—Ç–∞ —Ç–∞ –ú–µ–∂—ñ</div>

        <label>–ü—ñ–¥–∫–ª–∞–¥–∫–∞ (—Ç–∞–π–ª–∏)</label>
        <div class="row" style="gap:10px;align-items:end;margin-bottom:10px;flex-wrap:wrap;">
  <div style="flex:1;min-width:220px;">
    <label>–ü–æ—à—É–∫ –º—ñ—Å—Ç–∞</label>
    <input id="citySearch" class="input" placeholder="–í–≤–µ–¥–∏ –º—ñ—Å—Ç–æ ..." />
    <div id="cityResults" class="dropdown" style="display:none;"></div>
  </div>
  <div style="min-width:180px;">
    <label>–ü—ñ–¥–∫–ª–∞–¥–∫–∞ (—Ç–∞–π–ª–∏)</label>
    <select id="baseLayer">

          <option value="osm">OSM</option>
          <option value="dark">OSM Dark</option>
          <option value="sat">Satellite (ESRI)</option>
        </select>

        <div class="toggle">
          <div><b>–ö–æ—Ä–¥–æ–Ω –£–∫—Ä–∞—ó–Ω–∏</b><small>GeoJSON (–∫—Ä–∞—ó–Ω–∞)</small></div>
          <div class="switch on" id="swBorder"></div>
        </div>
        <div class="row" style="gap:10px;align-items:center;margin:-2px 0 12px 0;">
          <div class="muted" style="min-width:160px;">–ö–æ–Ω—Ç—É—Ä –∫—Ä–∞—ó–Ω–∏</div>
          <input type="color" id="borderStroke" class="input" style="width:64px;min-width:64px;padding:6px;" />
        </div>

        <div class="toggle">
          <div><b>–ú–µ–∂—ñ –æ–±–ª–∞—Å—Ç–µ–π</b><small>regiony.geojson</small></div>
          <div class="switch" id="swOblast"></div>
        </div>
        <div class="row" style="gap:10px;align-items:center;margin:-2px 0 12px 0;">
          <div class="muted" style="min-width:160px;">–ö–æ–Ω—Ç—É—Ä –æ–±–ª–∞—Å—Ç–µ–π</div>
          <input type="color" id="oblastStroke" class="input" style="width:64px;min-width:64px;padding:6px;" />
        </div>

        <div class="toggle">
          <div><b>–ú–µ–∂—ñ —Ä–∞–π–æ–Ω—ñ–≤</b><small>rayony.geojson (–≤–∞–∂–∫–∏–π —à–∞—Ä)</small></div>
          <div class="switch" id="swRaion"></div>
        </div>
        <div class="row" style="gap:10px;align-items:center;margin:-2px 0 12px 0;">
          <div class="muted" style="min-width:160px;">–ö–æ–Ω—Ç—É—Ä —Ä–∞–π–æ–Ω—ñ–≤</div>
          <input type="color" id="raionStroke" class="input" style="width:64px;min-width:64px;padding:6px;" />
        </div>

        <div class="toggle">
          <div><b>–¢—ñ–ª—å–∫–∏ –£–∫—Ä–∞—ó–Ω–∞ (—ñ–Ω—à–µ —á–æ—Ä–Ω–µ)</b><small>–º–∞—Å–∫–∞ –∑–∞ –º–µ–∂–∞–º–∏ –∫–æ—Ä–¥–æ–Ω—É</small></div>
          <div class="switch" id="swMask"></div>
        </div>

        <div class="hr"></div>

        <label>–í–∏–¥—ñ–ª–∏—Ç–∏ –æ–±–ª–∞—Å—Ç—ñ (–º—É–ª—å—Ç–∏–≤–∏–±—ñ—Ä)</label>
      <div class="card" style="margin-top:12px;">
        <div class="title">–í–∏–±—ñ—Ä –æ–±–ª–∞—Å—Ç–µ–π (—Å–≤—ñ—Ç—á—ñ)</div>
        <div class="row" style="gap:10px;flex-wrap:wrap;margin:8px 0;">
          <button class="btn small" id="oblastAll">–í–∏–±—Ä–∞—Ç–∏ –≤—Å—ñ</button>
          <button class="btn small" id="oblastNone">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>
        <div id="oblastToggleList" style="display:grid;grid-template-columns:1fr;gap:8px;max-height:260px;overflow:auto;padding-right:4px;"></div>
        <div class="muted" style="margin-top:8px;">–ú–æ–∂–Ω–∞ –≤–º–∏–∫–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ –æ–±–ª–∞—Å—Ç–µ–π. –ù–µ–≤–∏–±—Ä–∞–Ω—ñ –∑–∞—Ç–µ–º–Ω—é—é—Ç—å—Å—è –Ω–∞ 70%.</div>
      </div>

        <select id="oblastSelect" multiple size="8"></select>
        <div class="row" style="margin-top:8px;">
          <button class="btn small" id="btnOblastReset">–°–∫–∏–Ω—É—Ç–∏ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è</button>
        </div>
      </div>

      <div class="card">
        <div class="title">–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è —Ç–∞ –ü—Ä–æ–≥–Ω–æ–∑</div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó</b><small>–ª—ñ–Ω—ñ—è —Ä—É—Ö—É</small></div>
          <div class="switch on" id="swTraj"></div>
        </div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ª—ñ–Ω—ñ—ó –Ω–∞–ø—Ä—è–º–∫—É</b><small>—Å—Ç—Ä—ñ–ª–∫–∞ –≤–ø–µ—Ä–µ–¥</small></div>
          <div class="switch on" id="swDirLine"></div>
        </div>

        <label>–°—Ç–∏–ª—å —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó</label>
        <select id="trajStyle">
          <option value="solid">–°—É—Ü—ñ–ª—å–Ω–∞</option>
          <option value="dash">–ü—É–Ω–∫—Ç–∏—Ä–Ω–∞</option>
        </select>

        <div class="grid3">
          <div>
            <label>–ö–æ–ª—ñ—Ä</label>
            <input id="trajColor" type="color" value="#49d17d" />
          </div>
          <div>
            <label>–®–∏—Ä–∏–Ω–∞</label>
            <input id="trajWidth" type="number" value="3" min="1" />
          </div>
          <div>
            <label>–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å</label>
            <input id="trajOpacity" type="range" min="0" max="1" step="0.05" value="0.9" />
          </div>
        </div>

        <div class="hr"></div>

        <label>–ü—Ä–æ–≥–Ω–æ–∑ (—Ö–≤–∏–ª–∏–Ω)</label>
        <input id="forecastMin" type="number" min="1" value="20" />
        <div class="row" style="margin-top:8px;">
          <button class="btn small" id="btnForecastShow">–ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑</button>
          <button class="btn small" id="btnForecastClear">–ü—Ä–∏–±—Ä–∞—Ç–∏</button>
        </div>
      </div>

      <div class="card">
        <div class="title">–°–∏—Å—Ç–µ–º–∞</div>

        <label>–ß–∞—Å—Ç–æ—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</label>
        <select id="tickRate">
          <option value="1">1 —Å–µ–∫</option>
          <option value="2">2 —Å–µ–∫</option>
          <option value="3">3 —Å–µ–∫</option>
          <option value="5" selected>5 —Å–µ–∫</option>
          <option value="10">10 —Å–µ–∫</option>
          <option value="smooth">–ü–ª–∞–≤–Ω–∏–π</option>
        </select>

        <label>–†–µ–∂–∏–º –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
        <select id="renderMode">
          <option value="100">–ó–≤–∏—á–∞–π–Ω–∏–π (100%)</option>
          <option value="50">–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–∏–π (50%)</option>
        </select>

        <div class="toggle">
          <div><b>FPS –ª—ñ—á–∏–ª—å–Ω–∏–∫</b><small>–≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞</small></div>
          <div class="switch" id="swFps"></div>
        </div>
      </div>
    </section>

    <!-- TOOLS TAB -->
    <section class="tabPane" id="tab-tools" style="display:none;">
      <div class="card">
        <div class="title">–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</div>

        <div class="row">
          <button class="btn small" id="btnSpeed">‚è±Ô∏è –®–≤–∏–¥–∫—ñ—Å—Ç—å</button>
          <button class="btn small" id="btnWatermark">–í–æ–¥. –∑–Ω–∞–∫</button>
          <button class="btn small" id="btnStatic">–û–±'—î–∫—Ç–∏</button>
        </div>

        <div class="hr"></div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –º–æ—ó —Ü—ñ–ª—ñ</b><small>—Ñ—ñ–ª—å—Ç—Ä ‚Äú–ú–æ—ó‚Äù</small></div>
          <div class="switch on" id="swOnlyMine"></div>
        </div>

        <div class="hr"></div>

        <div class="hint">
          ‚ö†Ô∏è ‚Äú–°–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ / –ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∫–ª—é—á—ñ / –í–∏–π—Ç–∏‚Äù ‚Äî —Ü–µ —á–∞—Å—Ç–∏–Ω–∞ –≤—Ö–æ–¥—É –Ω–∞ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–º—É —Å–∞–π—Ç—ñ.
          –¢—É—Ç –≤—Ö–æ–¥—É –Ω–µ–º–∞—î, —Ç–æ–º—É —Ü–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤ —Ç–µ–∂ –Ω–µ–º–∞—î.
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn" id="btnReload">–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
          <button class="btn danger" id="btnClear2">Ô∏è–û—á–∏—Å—Ç–∏—Ç–∏ —Ü—ñ–ª—ñ</button>
        </div>
      </div>

      <div class="card">
        <div class="title">–ü–æ–≤—ñ—Ç—Ä—è–Ω—ñ —Ç—Ä–∏–≤–æ–≥–∏ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</div>
        <div class="hint">
          –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∞ –º–∞–ø–∞ –ø–æ–∫–∞–∑—É—î —Ç—Ä–∏–≤–æ–≥–∏ –∑ —Å–µ—Ä–≤—ñ—Å—ñ–≤. –î–ª—è –æ—Ñ—ñ—Ü—ñ–π–Ω–æ–≥–æ UkraineAlarm –ø–æ—Ç—Ä—ñ–±–µ–Ω API-–∫–ª—é—á, –∞ –¥–ª—è —ñ–Ω—à–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è CORS.
          –¢—É—Ç –∑—Ä–æ–±–ª–µ–Ω–æ <b>–ø–æ–ª–µ –¥–ª—è –∫–ª—é—á–∞</b> —ñ ‚Äú–∑–∞–≥–æ—Ç–æ–≤–∫—É‚Äù –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.
        </div>

        <label>–°–µ—Ä–≤—ñ—Å</label>
        <select id="alarmService">
          <option value="none">–í–∏–º–∫–Ω–µ–Ω–æ</option>
          <option value="ukrainealarm">UkraineAlarm (–ø–æ—Ç—Ä—ñ–±–µ–Ω –∫–ª—é—á)</option>
          <option value="custom">–°–≤—ñ–π GeoJSON (—ñ–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–æ–º)</option>
        </select>

        <label>UkraineAlarm API key</label>
        <input id="uaKey" placeholder="–í—Å—Ç–∞–≤ –∫–ª—é—á (—è–∫—â–æ –º–∞—î—à)" />

        <div class="toggle">
          <div><b>–í—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏ —Ç—Ä–∏–≤–æ–≥–∏ –æ–Ω–ª–∞–π–Ω</b><small>—è–∫—â–æ –∫–ª—é—á/–¥–∞–Ω—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ</small></div>
          <div class="switch" id="swAlarms"></div>
        </div>

        <label>–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å</label>
        <input id="alarmOpacity" type="range" min="0" max="1" step="0.05" value="0.10" />

        <div class="row" style="margin-top:8px;">
          <button class="btn small" id="btnAlarmImport">–Ü–º–ø–æ—Ä—Ç GeoJSON</button>
          <input id="alarmFile" type="file" accept="application/json" style="display:none" />
          <button class="btn small" id="btnAlarmClear">–ü—Ä–∏–±—Ä–∞—Ç–∏</button>
        </div>
      </div>

      <div class="card">
        <div class="title">–õ—ñ–Ω—ñ—è —Ñ—Ä–æ–Ω—Ç—É (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</div>
        <div class="hint">
          –ù–∞ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ–π –º–∞–ø—ñ —î —Ñ—Ä–æ–Ω—Ç. –¢—É—Ç ‚Äî —ñ–º–ø–æ—Ä—Ç GeoJSON (–ª—ñ–Ω—ñ—è/–ø–æ–ª—ñ–≥–æ–Ω), —â–æ–± —Ç–∏ –º—ñ–≥ –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –±—É–¥—å-—è–∫–µ –¥–∂–µ—Ä–µ–ª–æ.
        </div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑–∞—Ç–∏ —Ñ—Ä–æ–Ω—Ç</b><small>–≤–º–∏–∫–∞—î —à–∞—Ä —Ñ—Ä–æ–Ω—Ç—É</small></div>
          <div class="switch" id="swFront"></div>
        </div>

        <div class="grid2">
          <div>
            <label>–õ—ñ–Ω—ñ—è</label>
            <input id="frontLineColor" type="color" value="#ff4d4d" />
          </div>
          <div>
            <label>–ó–∞–ª–∏–≤–∫–∞</label>
            <input id="frontFillColor" type="color" value="#ff4d4d" />
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <button class="btn small" id="btnFrontImport">–Ü–º–ø–æ—Ä—Ç GeoJSON</button>
          <input id="frontFile" type="file" accept="application/json" style="display:none" />
          <button class="btn small" id="btnFrontClear">–ü—Ä–∏–±—Ä–∞—Ç–∏</button>
        </div>
      </div>
    </section>
</aside>

  <main id="mapWrap">
    <div id="map"></div>
    <canvas id="watermark"></canvas>
    
    <div id="topActions">
      <button id="btnTopAdd" class="topBtn" title="–î–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å">+</button>
      <button id="btnTopDraw" class="topBtn" title="–ú–∞–ª—é–≤–∞—Ç–∏ –ø–æ –∫–ª—ñ–∫–∞–º">‚úè</button>
      <button id="btnTogglePanel" class="topBtn smallText" title="–ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –ø–∞–Ω–µ–ª—å">–ü–∞–Ω–µ–ª—å</button>
    </div>
    <div id="drawHud">
      <button id="btnDrawFinish" class="mini" title="–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –ª—ñ–Ω—ñ—é">‚úì –ì–æ—Ç–æ–≤–æ</button>
      <button id="btnDrawUndo" class="mini" title="–°–∫–∞—Å—É–≤–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—é —Ç–æ—á–∫—É">‚Ü©</button>
      <button id="btnDrawClear" class="mini" title="–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –ª—ñ–Ω—ñ—ó">üßπ</button>
      <div id="drawColor" class="swatch" title="–ó–º—ñ–Ω–∏—Ç–∏ –∫–æ–ª—ñ—Ä"></div>
    </div>
    <div id="toast"></div>
    <div id="targetMenu"></div>
<div id="crosshair"></div>
    <div id="announce"></div>
    <div id="fps" class="mono">FPS: --</div>
  </main>

  <!-- Screenshot modal -->
  <div class="modalBack" id="shotModal">
    <div class="modal">
      <div class="modalTop">
        <b>–ó–Ω—ñ–º–æ–∫ –µ–∫—Ä–∞–Ω–∞</b>
        <div class="row">
          <button class="btn small" id="btnSaveShot">‚¨áÔ∏è –ó–±–µ—Ä–µ–≥—Ç–∏ —É —Ñ–∞–π–ª</button>
          <div class="closeX" id="btnCloseShot">√ó</div>
        </div>
      </div>
      <div class="modalBody">
        <div class="hint">–ó–∞—Ç–∏—Å–Ω—ñ—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ (–Ω–∞ iOS).</div>
        <div style="height:10px"></div>
        <img id="shotImg" alt="screenshot" />
      </div>
    </div>
  </div>

<script>

/* =========================
   Local clone: core features
   ========================= */

const LS_APP_PREFIX = "ua_radar_local_v3";
function getAppLSKey(){
  // –í–ê–ñ–õ–ò–í–û: –∫–ª—é—á –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∞–∫–∞—É–Ω—Ç–∞ (–Ω—ñ–∫ + –∫–æ–¥), —â–æ–± –¥–∞–Ω—ñ –Ω–µ –∑–º—ñ—à—É–≤–∞–ª–∏—Å—å
  const u = window.__MAP_USER__ || null;
  const uid = (u && u.uid) ? String(u.uid).trim()
            : (u && u.nick) ? String(u.nick).trim()
            : "guest";
  return `${LS_APP_PREFIX}:${uid.toLowerCase()}`;
}

const $ = (id) => document.getElementById(id);
const state = {
  addMode:false,
  addStep:0, // 0=need first click, 1=need direction click
  addFirstLatLng:null,
  filter:"mine", // mine|foreign
  onlyMine:true,
  seqNext: 1000,

  // settings
  showStatusIcons:true,
  hideThreats:false,
  showAnnounce:false,
  announceText:"",

  // drawing
  drawMode:false,
  drawColorIndex:0,
  showTurnPoints:false,
  glow:false,
  dynSize:true,

  iconColor:"#ffffff",
  iconSize:30,
  labelColor:"#ffffff",
  labelBg:"#000000",
  labelSize:12,
  labelBgOn:true,
  labelsOn:true,

  crosshairOn:false,
  crosshairType:"1",
  crosshairColor:"#ffffff",
  crosshairSize:60,
  crosshairOpacity:0.7,

  showId:false,
  idMode:"random",
  idFrom:1000,
  idTo:9999,
  idSuffix:"",
  idColor:"#ffffff",
  idSize:12,

  baseLayer:"osm",
  borderOn:true,
  borderStroke:"#ffffff",
  oblastStroke:"#ffffff",
  raionStroke:"#ffffff",
  oblastOn:false,
  raionOn:false,
  maskOn:false,
  highlightedOblasts:[],

  trajOn:true,
  dirLineOn:true,
  trajStyle:"solid",
  trajColor:"#49d17d",
  trajWidth:3,
  trajOpacity:0.9,
  forecastMin:20,

  tickRate:"5",
  renderMode:"100",
  fpsOn:false,

  // optional overlays
  alarmsOn:false,
  alarmService:"none",
  uaKey:"",
  alarmOpacity:0.10,

  showFrontLine:false,
  showOccupied:false,

  frontOn:false,
  frontLineColor:"#ff4d4d",
  frontFillColor:"#ff4d4d",
};

function toast(msg){
  const el = $("toast");
  if(!el) return;
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>{ el.style.display="none"; }, 2200);
}


let data = {
  targets: [],  // {id, owner: mine|foreign, type, status, name, count, speed, rangeKm, heading, threatRadius, threatAngle, lat,lng, createdAt, paused, points:[{lat,lng}], trajectory:[{lat,lng,t}]}
  alarmsGeojson: null,
  frontGeojson: null,
};

const layersById = new Map(); // id -> {marker,label,dirLine,traj,turnPoints,threatSector,idLabel}
let forecastLayer = null;

// --- Helpers ---
function uid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function kmToMeters(km){ return km*1000; }
function deg2rad(d){ return d*Math.PI/180; }
function rad2deg(r){ return r*180/Math.PI; }

function destinationPoint(lat, lng, bearingDeg, distM) {
  const R = 6371000;
  const brng = deg2rad(bearingDeg);
  const œÜ1 = deg2rad(lat);
  const Œª1 = deg2rad(lng);
  const Œ¥ = distM / R;

  const œÜ2 = Math.asin(Math.sin(œÜ1)*Math.cos(Œ¥) + Math.cos(œÜ1)*Math.sin(Œ¥)*Math.cos(brng));
  const Œª2 = Œª1 + Math.atan2(Math.sin(brng)*Math.sin(Œ¥)*Math.cos(œÜ1), Math.cos(Œ¥) - Math.sin(œÜ1)*Math.sin(œÜ2));
  return { lat: rad2deg(œÜ2), lng: rad2deg(Œª2) };
}

function statusDot(status){
  if(status==="threat") return "danger";
  if(status==="acoustic") return "acoustic";
  if(status==="acousticThreat") return "danger";
  if(status==="stop") return "warn";
  return "ok";
}
function statusText(status){
  return ({
    move:"–†—É—Ö",
    threat:"–ó–∞–≥—Ä–æ–∑–∞",
    acoustic:"–ê–∫—É—Å—Ç–∏–∫–∞",
    acousticThreat:"–ê–∫—É—Å—Ç. –∑–∞–≥—Ä–æ–∑–∞",
    stop:"–°—Ç–æ–ø"
  })[status] || status;
}

// --- Map ---
const map = L.map("map", { zoomControl:true }).setView([48.3794, 31.1656], 6);
// === Base map layers (light/dark) ===
const lightLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:19, attribution:"¬© OpenStreetMap"});
const darkLayer  = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {maxZoom:19, attribution:"¬© CARTO"});
if(typeof lightLayer!=="undefined") lightLayer.addTo(map);

// === Front line & occupied overlays (NO fetch; data is embedded) ===
// NOTE: Replace coordinates inside FRONTLINE_GEOJSON / OCCUPIED_GEOJSON with your real data when needed.
const FRONTLINE_GEOJSON = {"type":"FeatureCollection","features":[
  {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[
    [29.0,50.0],[30.5,49.6],[32.0,49.0],[34.0,48.4],[36.0,47.8],[38.0,47.3]
  ]}}
]};

const OCCUPIED_GEOJSON = {"type":"FeatureCollection","features":[
  {"type":"Feature","properties":{},"geometry":{"type":"Polygon","coordinates":[[
    [36.0,48.8],[40.0,48.8],[40.0,46.0],[36.0,46.0],[36.0,48.8]
  ]]}}
]};

let frontLineLayer = L.geoJSON(FRONTLINE_GEOJSON, {
  pane: "overlayPane",
  style: ()=>({ weight:3, opacity:1, dashArray:"6 6" })
});

let occupiedLayer = L.geoJSON(OCCUPIED_GEOJSON, {
  pane: "overlayPane",
  style: ()=>({ weight:1, opacity:0.9, fillOpacity:0.25 })
});

function applyFrontOccupied(){
  // line
  if(state.showFrontLine){
    if(!map.hasLayer(frontLineLayer)) frontLineLayer.addTo(map);
  } else {
    if(map.hasLayer(frontLineLayer)) map.removeLayer(frontLineLayer);
  }
  // occupied fill
  if(state.showOccupied){
    if(!map.hasLayer(occupiedLayer)) occupiedLayer.addTo(map);
  } else {
    if(map.hasLayer(occupiedLayer)) map.removeLayer(occupiedLayer);
  }
}


const baseLayers = {
  osm: L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19, attribution:"&copy; OpenStreetMap" }),
  dark: L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { maxZoom:19, attribution:"&copy; OpenStreetMap, CARTO" }),
  sat: L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", { maxZoom:19, attribution:"Tiles &copy; Esri" }),
};
baseLayers.osm.addTo(map);

// Borders/regions/raions from open geojson repos
// regiony/rayony/hromady dataset: https://github.com/slawomirmatuszak/ukrainian_geodata ÓàÄciteÓàÇturn8view0ÓàÅ
const GEO_BASE = "https://raw.githubusercontent.com/slawomirmatuszak/ukrainian_geodata/main/";
const borderUrl = "https://raw.githubusercontent.com/EugeneBorshch/ukraine_geojson/master/UA_FULL_Ukraine.geojson"; // UA outline ÓàÄciteÓàÇturn4view0ÓàÅ

let borderLayer = null;
let oblastLayer = null;
let raionLayer = null;
let maskLayer = null;

async function fetchJson(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error("fetch failed " + r.status);
  return await r.json();
}

function styleBorder(){ return { color: state.borderStroke || "#ffffff", weight:2, opacity:0.9, fillOpacity:0 }; }
function styleRegion(f){ 
  const name = (f.properties?.name || f.properties?.NAME_1 || f.properties?.region || "").toString();
  const isHi = state.highlightedOblasts.includes(name);
  return {
    color: isHi ? "#6fe3ff" : (state.oblastStroke || "#ffffff"),
    weight: isHi ? 3 : 1.2,
    opacity: 0.85,
    fillOpacity: isHi ? 0.08 : 0.0,
    fillColor: "#6fe3ff",
  };
}
function styleRaion(){ return { color: state.raionStroke || "#ffffff", weight:0.8, opacity:0.35, fillOpacity:0 }; }

async function ensureBorder(){
  if(borderLayer) return;
  const gj = await fetchJson(borderUrl);
  borderLayer = L.geoJSON(gj, { style: styleBorder }).addTo(map);
  rebuildMask(); // if mask enabled later
}

async function ensureOblast(){
  if(oblastLayer) return;
  const gj = await fetchJson(GEO_BASE + "regiony.geojson");
  oblastLayer = L.geoJSON(gj, { style: styleRegion });
  populateOblastSelect(gj);
}
async function ensureRaion(){
  if(raionLayer) return;
  const gj = await fetchJson(GEO_BASE + "rayony.geojson");
  raionLayer = L.geoJSON(gj, { style: styleRaion });
}

function rebuildMask(){
  if(maskLayer){ map.removeLayer(maskLayer); maskLayer=null; }
  if(!state.maskOn || !borderLayer) return;

  // Simple mask: world rectangle with hole (Ukraine polygon) using leaflet geoJSON
  const world = [[-90,-180],[-90,180],[90,180],[90,-180],[-90,-180]];
  const uk = borderLayer.toGeoJSON();
  // Get first polygon coords
  const ukCoords = (uk.features?.[0]?.geometry?.coordinates) || [];
  // GeoJSON Polygon with hole: [outer, hole]
  const mask = {
    "type":"Feature",
    "properties":{},
    "geometry":{
      "type":"Polygon",
      "coordinates":[ world, ...ukCoords ] // works for MultiPolygon too-ish; good enough for this local clone
    }
  };
  maskLayer = L.geoJSON(mask, {
    style:{ color:"#000000", weight:0, fillColor:"#000000", fillOpacity:0.65 }
  }).addTo(map);
}

// --- Markers (icon+label) ---
function makeIconForTarget(t, sizePx){
  const glow = state.glow ? `filter: drop-shadow(0 0 10px rgba(255,255,255,0.35));` : "";
const type = (t.type||"").toString().trim().toLowerCase();

// === Custom SVG icons (user-provided) ===
const typeNorm = type
  .replace(/[\u2010\u2011\u2012\u2013\u2014\u2212]/g,"-")
  .replace(/\s+/g," ")
  .replace(/[‚Äô'`]/g,"'")
  .trim();
const typeCompact = typeNorm.replace(/\s+/g,"").replace(/-/g,"");

function pickSvgByType(){
  // NEW: –ö–æ—Ä–∞–±–µ–ª—å
  if(typeNorm.includes("–∫–æ—Ä–∞–±–µ–ª—å") || typeNorm.includes("ship")) return `<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="931.000000pt" height="680.000000pt" viewBox="0 0 931.000000 680.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,680.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M5 3400 c0 -1873 1 -2639 2 -1702 2 936 2 2468 0 3405 -1 936 -2 170
-2 -1703z"/>
<path d="M4681 4263 c-21 -21 -44 -56 -51 -78 -7 -22 -16 -50 -21 -63 -5 -13
-9 -42 -9 -66 l0 -43 -56 -6 c-68 -7 -86 -20 -82 -61 2 -24 12 -35 43 -53 22
-12 57 -25 78 -29 l39 -6 -6 -52 c-14 -108 -15 -112 -49 -122 -18 -5 -36 -19
-42 -32 -10 -23 -93 -55 -108 -41 -14 12 -36 155 -30 198 6 44 -21 100 -62
127 -21 14 -27 13 -76 -10 -29 -15 -56 -26 -61 -26 -4 0 -8 18 -8 40 0 30 -7
47 -25 65 -29 30 -35 31 -63 5 -20 -19 -22 -30 -22 -140 0 -109 -2 -120 -20
-130 -11 -6 -20 -17 -20 -25 0 -8 -9 -19 -20 -25 -33 -18 -44 -48 -26 -75 25
-38 20 -45 -33 -45 -47 0 -49 1 -54 33 -13 77 -30 143 -39 154 -14 17 -65 30
-168 42 -47 6 -123 15 -169 21 -72 9 -87 8 -108 -6 -44 -28 -53 -14 -53 80 0
64 -4 88 -16 100 -32 32 -84 11 -84 -34 0 -37 -13 -45 -35 -20 -21 24 -58 26
-79 5 -9 -9 -33 -15 -64 -15 -52 0 -82 -21 -97 -68 -6 -20 -11 -22 -38 -15
-52 13 -104 6 -137 -17 -37 -26 -50 -56 -50 -111 0 -36 -2 -39 -29 -39 -27 0
-28 -2 -34 -56 -3 -30 -11 -62 -17 -69 -8 -10 -11 -46 -9 -107 l4 -93 -43 -3
c-37 -3 -46 1 -76 32 -21 23 -43 36 -58 36 -30 0 -94 -25 -103 -40 -4 -6 -148
-10 -410 -10 l-404 0 -10 38 c-6 20 -11 44 -11 53 0 9 -7 19 -15 23 -11 4 -15
20 -15 54 0 51 -23 89 -38 64 -4 -6 -20 -15 -35 -21 -22 -9 -27 -17 -27 -45 0
-22 6 -38 16 -44 13 -7 16 -19 12 -50 -5 -30 -2 -42 9 -46 15 -6 15 -26 -3
-188 -5 -51 -3 -62 18 -88 12 -16 39 -53 58 -81 51 -76 88 -109 120 -109 18 0
20 -6 20 -75 0 -43 4 -75 10 -75 6 0 10 -9 10 -20 0 -13 7 -20 20 -20 11 0 20
-4 20 -10 0 -6 37 -10 91 -10 87 0 92 1 120 29 17 17 29 40 29 55 0 46 21 35
94 -46 33 -37 58 -35 87 6 16 24 33 36 59 40 64 11 99 7 119 -13 19 -19 47
-19 1173 -18 l1153 2 3 -22 c3 -22 8 -23 83 -23 74 0 82 2 105 27 l24 26 708
-7 c389 -5 815 -12 947 -16 227 -7 244 -9 315 -35 65 -24 94 -29 217 -33 174
-5 167 -9 288 143 159 198 332 379 442 462 78 58 90 79 78 141 -4 20 -10 108
-13 194 -6 141 -9 159 -27 172 -25 19 -36 20 -60 2 -17 -12 -20 -32 -26 -150
-4 -85 -11 -142 -18 -149 -9 -9 -93 -13 -298 -16 l-286 -3 -18 23 c-17 22 -26
24 -130 27 -96 3 -118 7 -148 26 -66 42 -103 51 -137 33 -54 -29 -85 -62 -93
-97 -6 -28 -11 -34 -27 -31 -10 3 -99 6 -196 8 -138 3 -178 7 -178 17 0 27
-36 46 -88 46 -28 0 -54 5 -57 10 -3 6 -42 10 -85 10 l-78 0 -7 30 c-9 40 -31
50 -112 50 -85 0 -104 -12 -112 -71 l-6 -44 -107 -3 c-121 -3 -113 -9 -109 78
2 24 7 52 12 62 5 9 9 89 9 178 0 160 -6 195 -36 213 -10 6 -14 32 -14 90 -1
93 -13 120 -56 120 -51 0 -54 -16 -54 -275 l0 -238 -35 0 -35 0 0 239 0 240
-26 20 c-27 21 -50 18 -71 -8 -8 -10 -12 -51 -13 -104 l0 -88 -43 6 c-40 6
-46 4 -70 -25 -22 -25 -33 -31 -59 -28 l-33 3 -6 120 c-4 66 -7 121 -8 123 -6
14 -49 18 -68 6 -30 -19 -34 -18 -71 16 -18 17 -40 30 -48 30 -8 0 -32 -17
-53 -37z"/>
</g>
</svg>`;
  // NEW: –ù–µ–≤—Å. —Ü—ñ–ª—å (–Ω–µ–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
  if(typeNorm.includes("–Ω–µ–≤—Å") || typeNorm.includes("–Ω–µ–≤—Å—Ç–∞–Ω–æ–≤") || typeNorm.includes("–Ω–µ–≤—Å—Ç") || typeNorm.includes("–Ω–µ–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞") || typeNorm.includes("–Ω–µ–≤—Å. —Ü—ñ–ª—å") || typeNorm.includes("–Ω–µ–≤—Å.—Ü—ñ–ª—å")) return `<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="66.000000pt" height="61.000000pt" viewBox="0 0 66.000000 61.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,61.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M4 305 c0 -171 2 -242 3 -158 2 83 2 223 0 310 -1 87 -3 19 -3 -152z"/>
<path d="M654 305 c0 -171 2 -242 3 -158 2 83 2 223 0 310 -1 87 -3 19 -3
-152z"/>
<path d="M477 444 c-3 -3 -48 -21 -99 -39 -51 -17 -122 -44 -157 -58 -36 -15
-70 -27 -77 -27 -21 0 -27 -20 -7 -26 29 -10 90 -37 255 -113 69 -31 118 -47
118 -38 0 4 -22 50 -51 109 -11 23 -11 63 0 86 27 54 51 104 51 108 0 6 -26 5
-33 -2z"/>
</g>
</svg>`;
  // NEW: –¢–∞–∫—Ç–∏—á–Ω–∞ –∞–≤—ñ–∞—Ü—ñ—è / –¢–ê
  if(typeNorm.includes("—Ç–∞–∫—Ç–∏—á") || (typeNorm.includes("–∞–≤—ñ–∞—Ü") && (typeNorm.includes("/—Ç–∞") || typeNorm.endsWith(" —Ç–∞") || typeNorm==="—Ç–∞"))) return `<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="870.000000pt" height="873.000000pt" viewBox="0 0 870.000000 873.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,873.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M5792 7053 l-333 -3 3 -28 3 -27 198 -9 c156 -7 197 -12 193 -22 -3
-7 -343 -413 -755 -901 l-751 -888 -132 -88 c-100 -66 -139 -87 -160 -85 l-28
3 105 229 c58 126 107 238 111 248 5 17 -3 18 -108 18 l-113 -1 -332 -294
-331 -295 -519 -145 -518 -146 -350 2 c-309 1 -370 -1 -520 -21 -328 -42 -429
-72 -692 -204 l-128 -64 -145 -6 c-80 -3 -194 -9 -253 -12 l-108 -6 3 -37 3
-36 85 -7 c47 -3 153 -7 235 -7 166 -2 150 2 360 -91 245 -109 322 -131 610
-176 155 -25 205 -28 560 -33 l390 -7 315 -76 c173 -43 399 -105 502 -140
l187 -63 313 -271 c172 -149 327 -283 343 -297 29 -24 34 -25 127 -18 l96 6
-114 249 c-88 191 -112 251 -102 257 18 12 23 10 187 -93 l146 -91 748 -891
747 -891 -187 -5 -188 -5 0 -40 0 -40 63 0 c34 1 283 2 552 3 l490 2 0 25 c0
18 -457 1785 -486 1878 -5 16 7 17 163 17 l168 -1 425 -464 c234 -256 437
-479 453 -495 l27 -30 174 120 c149 103 173 123 169 142 -2 13 -30 194 -63
402 -33 209 -65 383 -71 386 -6 4 -82 29 -170 56 -87 27 -159 51 -159 54 0 3
39 19 88 34 48 16 124 42 170 58 l82 30 0 139 c0 136 0 139 -22 144 -13 3 -88
19 -168 35 -79 17 -145 32 -147 33 -4 4 1103 68 1170 67 56 0 57 1 57 28 0 26
4 29 58 40 120 26 154 58 136 130 -7 30 -17 41 -54 59 -25 12 -66 24 -92 28
-38 5 -47 11 -50 28 -3 20 -8 22 -68 19 -67 -3 -1090 54 -1097 62 -2 2 9 7 24
10 15 4 79 23 141 43 l112 35 0 129 c0 125 -1 129 -22 134 -13 3 -99 21 -192
40 -93 19 -171 36 -173 38 -2 2 83 35 189 72 106 37 194 68 195 69 3 2 83 839
81 841 -3 2 -297 174 -309 181 -4 2 -215 -218 -469 -490 l-463 -493 -90 -7
c-101 -7 -217 -8 -217 -2 0 2 105 422 234 933 129 510 237 943 241 961 l7 32
-229 -2 c-125 -2 -378 -4 -561 -5z"/>
</g>
</svg>`;
  // NEW: –¢—É-160
  if(typeNorm.includes("—Ç—É-160") || typeNorm.includes("—Ç—É 160") || typeNorm.includes("tu-160") || typeCompact.includes("—Ç—É160") || typeCompact.includes("tu160")) return `<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="876.000000pt" height="874.000000pt" viewBox="0 0 876.000000 874.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,874.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M5 4370 c0 -2406 1 -3391 2 -2187 2 1203 2 3171 0 4375 -1 1203 -2
218 -2 -2188z"/>
<path d="M5176 8191 c-3 -5 -27 -12 -53 -15 -56 -8 -131 -23 -188 -39 -40 -10
-95 -52 -95 -71 0 -5 -8 -28 -18 -50 -10 -23 -29 -68 -42 -101 -12 -33 -33
-83 -46 -112 -13 -28 -24 -59 -24 -67 0 -8 -4 -17 -9 -20 -5 -3 -12 -17 -15
-31 -4 -14 -17 -49 -30 -78 -12 -28 -31 -74 -41 -102 -10 -27 -26 -68 -35 -90
-10 -22 -30 -71 -45 -110 -32 -82 -142 -359 -157 -395 -6 -14 -17 -40 -24 -57
-8 -18 -21 -48 -29 -65 -8 -18 -17 -46 -21 -63 -4 -16 -10 -35 -15 -40 -7 -10
-75 -175 -106 -260 -8 -22 -20 -53 -28 -70 -7 -16 -34 -84 -60 -150 -26 -66
-53 -132 -61 -147 -8 -14 -14 -31 -14 -38 0 -6 -12 -37 -26 -68 -45 -99 -52
-116 -59 -142 -4 -14 -17 -47 -30 -75 -12 -27 -33 -79 -45 -115 -28 -78 -44
-97 -107 -130 -26 -14 -67 -37 -90 -52 -23 -16 -46 -28 -51 -28 -5 0 -15 -7
-22 -15 -7 -8 -19 -15 -28 -15 -8 0 -34 -16 -58 -35 -23 -19 -49 -35 -58 -35
-8 0 -18 -5 -21 -10 -4 -6 -26 -20 -50 -31 -24 -11 -51 -29 -61 -40 -9 -10
-23 -19 -30 -19 -7 0 -29 -10 -48 -22 -88 -57 -108 -68 -120 -68 -8 0 -20 -7
-27 -16 -7 -9 -22 -20 -34 -25 -11 -5 -33 -18 -50 -29 -16 -10 -53 -30 -81
-44 -28 -14 -57 -32 -64 -41 -7 -8 -20 -15 -29 -15 -9 0 -21 -4 -27 -9 -15
-14 -104 -61 -115 -61 -6 0 -25 -11 -43 -25 -18 -14 -37 -25 -43 -25 -9 0 -33
-12 -118 -58 -11 -6 -51 -25 -90 -42 -38 -18 -92 -42 -120 -55 -27 -13 -65
-26 -82 -30 -18 -4 -35 -11 -38 -16 -4 -5 -16 -9 -29 -9 -12 0 -26 -4 -32 -9
-5 -4 -27 -13 -49 -19 -22 -6 -65 -18 -95 -27 -65 -19 -59 -18 -220 -44 -237
-39 -286 -43 -500 -46 -272 -5 -370 -11 -478 -30 -127 -23 -226 -47 -237 -56
-5 -5 -20 -9 -33 -9 -13 0 -57 -11 -98 -25 -41 -14 -80 -25 -87 -25 -7 0 -25
-13 -40 -28 l-27 -28 22 -21 c13 -11 50 -28 83 -37 33 -10 71 -21 85 -26 54
-19 319 -80 385 -89 39 -6 133 -13 210 -16 490 -20 574 -25 665 -45 52 -11
109 -20 125 -20 41 0 317 -81 374 -109 9 -5 30 -14 46 -21 17 -7 44 -18 60
-25 17 -7 46 -19 65 -27 81 -31 483 -239 550 -284 19 -13 38 -24 41 -24 4 0
36 -18 70 -40 35 -22 75 -45 88 -50 13 -6 38 -21 55 -33 35 -24 78 -50 116
-67 14 -6 39 -22 57 -36 17 -13 36 -24 41 -24 4 0 26 -13 48 -30 21 -16 44
-30 51 -30 6 0 25 -11 41 -25 17 -14 35 -25 42 -25 6 0 26 -11 43 -24 18 -13
42 -27 53 -30 12 -4 29 -15 39 -26 10 -11 24 -20 32 -20 7 0 35 -16 61 -35 38
-29 52 -48 71 -98 12 -34 31 -81 42 -104 10 -24 19 -46 19 -49 0 -3 6 -20 14
-37 8 -18 38 -93 67 -167 60 -157 69 -177 114 -285 9 -22 20 -49 25 -60 4 -11
13 -36 20 -55 13 -38 20 -56 45 -115 9 -22 20 -49 25 -60 4 -11 13 -36 20 -55
7 -19 19 -51 27 -70 8 -19 18 -44 23 -55 4 -11 15 -36 24 -57 9 -20 16 -41 16
-47 0 -6 4 -19 10 -29 8 -15 27 -59 50 -117 4 -11 13 -36 20 -55 7 -19 18 -48
25 -65 7 -16 18 -43 25 -60 7 -16 18 -43 25 -60 29 -71 34 -82 45 -115 7 -19
23 -58 36 -86 13 -28 24 -58 24 -67 0 -9 4 -18 9 -22 5 -3 13 -20 17 -37 3
-18 10 -39 15 -48 11 -20 32 -73 59 -145 13 -33 31 -76 40 -95 10 -19 21 -46
25 -60 4 -14 13 -38 20 -55 7 -16 23 -57 36 -90 33 -87 46 -97 141 -118 94
-21 124 -28 222 -52 68 -16 69 -16 93 7 22 20 24 28 18 73 -4 27 -13 75 -20
105 -8 30 -21 93 -30 140 -9 47 -20 103 -25 125 -15 65 -40 187 -46 225 -3 19
-26 132 -50 250 -69 333 -75 362 -85 401 -5 20 -9 50 -9 67 0 17 -4 34 -10 37
-5 3 -10 21 -10 38 0 18 -5 48 -10 67 -6 19 -15 58 -20 85 -6 28 -15 73 -20
100 -6 28 -15 73 -20 100 -5 28 -16 84 -25 125 -9 41 -21 95 -25 120 -5 25
-20 99 -35 165 -14 66 -30 145 -34 175 -5 31 -14 73 -19 95 -6 22 -20 90 -32
150 -11 61 -25 130 -31 155 -10 44 -52 100 -74 100 -7 0 -20 9 -30 20 -10 11
-24 20 -31 20 -7 0 -16 5 -20 11 -5 9 1 10 19 5 32 -8 527 -8 692 0 190 9 243
18 276 50 28 27 29 31 29 124 0 62 -4 100 -12 108 -10 10 -10 17 0 32 7 12 12
57 12 113 0 84 -2 96 -22 114 -13 12 -36 23 -53 25 -25 3 -22 6 25 15 30 7 84
14 120 16 104 7 631 66 680 77 25 5 69 13 98 16 l54 7 99 -99 c54 -54 99 -103
99 -107 0 -5 79 -90 175 -189 96 -99 175 -185 175 -192 0 -6 26 -37 58 -69
l58 -57 165 0 c163 0 166 0 189 25 24 26 24 30 -15 120 -8 17 -17 43 -21 59
-4 16 -13 41 -20 55 -8 14 -14 33 -14 41 0 9 -4 20 -8 25 -5 6 -21 44 -36 85
-15 41 -31 84 -36 95 -28 66 -110 294 -110 307 0 16 41 24 235 48 229 28 264
43 269 110 2 25 -5 38 -34 64 -32 29 -47 34 -106 40 -38 4 -95 12 -127 17 -32
6 -72 12 -90 14 -122 13 -147 17 -152 24 -4 7 12 53 50 146 24 56 33 80 45
115 13 38 25 68 45 115 7 17 22 55 33 85 11 30 36 96 55 145 19 50 41 110 48
134 12 41 12 45 -10 62 -21 17 -42 19 -186 19 l-163 0 -32 -37 c-18 -21 -111
-120 -206 -220 -96 -100 -174 -185 -174 -190 0 -4 -58 -66 -129 -137 -101
-100 -133 -127 -148 -122 -10 3 -43 8 -73 11 -29 2 -60 7 -69 9 -21 7 -270 37
-341 42 -30 2 -82 8 -115 13 -33 6 -140 18 -238 28 -97 10 -169 21 -160 25 10
3 30 7 44 7 14 1 35 11 47 24 19 21 22 35 22 118 0 62 -4 99 -12 107 -10 10
-10 17 0 32 7 12 12 57 12 113 0 89 -1 94 -28 120 -32 31 -90 44 -207 46 -44
1 -161 6 -260 12 -160 9 -408 6 -505 -6 -27 -4 -30 -3 -15 4 11 6 45 27 75 48
63 45 86 84 100 175 5 35 16 95 25 133 9 39 22 108 31 155 8 47 21 110 29 140
8 30 27 120 44 200 16 80 44 210 60 290 17 80 31 155 31 168 0 13 4 31 9 40 5
9 11 33 14 53 2 20 7 41 11 47 3 5 10 38 15 73 6 35 17 96 26 134 9 39 21 93
25 120 5 28 20 102 34 165 14 63 41 196 61 295 20 99 40 196 45 215 12 44 57
253 65 300 3 19 10 62 15 94 6 33 12 62 15 65 3 2 -5 15 -17 28 -16 17 -32 23
-64 23 -24 0 -45 -4 -48 -9z"/>
</g>
</svg>`;
  // NEW: –®–∞—Ö–µ–¥
  if(typeNorm.includes("—à–∞—Ö–µ–¥") || typeNorm.includes("shahed")) return `<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="949.000000pt" height="948.000000pt" viewBox="0 0 949.000000 948.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,948.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M0 4740 c0 -3153 3 -4740 10 -4740 7 0 10 1580 10 4720 l0 4720 4735
0 c4728 0 4735 0 4735 20 0 20 -7 20 -4745 20 l-4745 0 0 -4740z"/>
<path d="M4847 7256 c-10 -8 -24 -40 -32 -72 -32 -133 -64 -271 -69 -294 -3
-14 -20 -104 -40 -200 -19 -96 -75 -384 -125 -640 -50 -256 -95 -485 -101
-510 -5 -25 -21 -107 -36 -182 -15 -76 -31 -142 -34 -149 -6 -8 -250 -11 -946
-9 -2479 6 -2253 7 -2314 -13 -67 -23 -102 -38 -202 -88 -118 -58 -144 -79
-253 -188 l-100 -101 108 -108 c98 -98 120 -115 225 -170 132 -69 203 -97 282
-112 35 -7 304 -13 745 -16 380 -2 924 -6 1210 -8 286 -3 675 -5 864 -6 191
-1 352 -5 362 -10 17 -9 26 -42 49 -170 7 -36 18 -96 25 -135 8 -38 18 -97 24
-130 6 -33 20 -109 31 -170 11 -60 34 -186 51 -280 17 -93 32 -179 34 -190 3
-11 16 -87 30 -169 14 -83 28 -153 30 -156 3 -4 7 -25 9 -46 8 -58 41 -233 71
-369 14 -66 30 -145 35 -175 14 -80 33 -93 135 -87 121 7 318 37 332 50 8 9 6
38 -9 122 -21 119 -30 169 -77 435 -16 96 -40 227 -51 290 -11 63 -32 178 -46
255 -14 77 -29 163 -34 190 -11 58 -71 396 -100 565 -11 63 -22 122 -25 130
-12 40 2 42 286 43 425 2 2372 -12 2581 -19 l187 -7 78 -83 c43 -46 105 -114
138 -150 33 -37 69 -72 80 -79 12 -8 73 -16 157 -21 l137 -7 11 24 c10 23 20
78 59 304 17 96 19 155 17 460 -2 306 -5 365 -24 470 -12 66 -24 138 -28 160
-14 81 -9 79 -167 72 l-140 -6 -166 -164 -166 -163 -675 2 c-1214 4 -2326 13
-2343 20 -19 7 -19 7 14 177 11 53 21 109 24 125 3 15 9 47 14 72 5 25 20 113
34 195 14 83 33 184 41 225 19 96 72 374 97 510 10 58 24 128 29 155 26 128
42 212 45 235 2 14 15 82 29 152 14 70 26 139 26 153 0 29 3 28 -179 55 -155
23 -229 25 -254 6z"/>
</g>
</svg>`;
  // 1) –•-101
  if(typeNorm.includes("—Ö-101") || typeNorm.includes("x-101") || typeCompact.includes("—Ö101") || typeCompact.includes("x101")) return `<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 viewBox="0 0 949.000000 948.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,948.000000) scale(0.100000,-0.100000)"
fill="currentColor" stroke="none">
<path d="M0 4740 c0 -3153 3 -4740 10 -4740 7 0 10 1580 10 4720 l0 4720 4735
0 c4728 0 4735 0 4735 20 0 20 -7 20 -4745 20 l-4745 0 0 -4740z"/>
<path d="M4847 7256 c-10 -8 -24 -40 -32 -72 -32 -133 -64 -271 -69 -294 -3
-14 -20 -104 -40 -200 -19 -96 -75 -384 -125 -640 -50 -256 -95 -485 -101
-510 -5 -25 -21 -107 -36 -182 -15 -76 -31 -142 -34 -149 -6 -8 -250 -11 -946
-9 -2479 6 -2253 7 -2314 -13 -67 -23 -102 -38 -202 -88 -118 -58 -144 -79
-253 -188 l-100 -101 108 -108 c98 -98 120 -115 225 -170 132 -69 203 -97 282
-112 35 -7 304 -13 745 -16 380 -2 924 -6 1210 -8 286 -3 675 -5 864 -6 191
-1 352 -5 362 -10 17 -9 26 -42 49 -170 7 -36 18 -96 25 -135 8 -38 18 -97 24
-130 6 -33 20 -109 31 -170 11 -60 34 -186 51 -280 17 -93 32 -179 34 -190 3
-11 16 -87 30 -169 14 -83 28 -153 30 -156 3 -4 7 -25 9 -46 8 -58 41 -233 71
-369 14 -66 30 -145 35 -175 14 -80 33 -93 135 -87 121 7 318 37 332 50 8 9 6
38 -9 122 -21 119 -30 169 -77 435 -16 96 -40 227 -51 290 -11 63 -32 178 -46
255 -14 77 -29 163 -34 190 -11 58 -71 396 -100 565 -11 63 -22 122 -25 130
-12 40 2 42 286 43 425 2 2372 -12 2581 -19 l187 -7 78 -83 c43 -46 105 -114
138 -150 33 -37 69 -72 80 -79 12 -8 73 -16 157 -21 l137 -7 11 24 c10 23 20
78 59 304 17 96 19 155 17 460 -2 306 -5 365 -24 470 -12 66 -24 138 -28 160
-14 81 -9 79 -167 72 l-140 -6 -166 -164 -166 -163 -675 2 c-1214 4 -2326 13
-2343 20 -19 7 -19 7 14 177 11 53 21 109 24 125 3 15 9 47 14 72 5 25 20 113
34 195 14 83 33 184 41 225 19 96 72 374 97 510 10 58 24 128 29 155 26 128
42 212 45 235 2 14 15 82 29 152 14 70 26 139 26 153 0 29 3 28 -179 55 -155
23 -229 25 -254 6z"/>
</g>
</svg>`;
  // 2) –ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ –∫—É–ª—è
  if(typeNorm.includes("–ø–æ–≤—ñ—Ç—Ä—è–Ω–∞ –∫—É–ª—è") || typeNorm === "–∫—É–ª—è" || typeNorm.includes("balloon")) return `<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 viewBox="0 0 955.000000 947.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,947.000000) scale(0.100000,-0.100000)"
fill="currentColor" stroke="none">
<path d="M2388 9463 c1317 -2 3468 -2 4780 0 1313 1 236 2 -2393 2 -2629 0
-3703 -1 -2387 -2z"/>
<path d="M6785 5365 c-5 -2 -44 -11 -85 -20 -110 -24 -281 -92 -296 -116 -3
-5 -20 -15 -37 -23 -72 -30 -188 -150 -269 -276 -77 -121 -126 -241 -143 -352
-5 -30 -11 -38 -38 -47 -32 -11 -532 -8 -727 4 -47 2 -166 7 -265 10 -99 3
-247 10 -330 15 -249 16 -347 22 -405 25 -98 5 -129 17 -153 64 -39 74 -90
167 -97 176 -4 6 -29 51 -55 100 -26 50 -66 125 -89 168 -22 43 -47 90 -55
105 -23 46 -62 82 -85 77 -12 -2 -24 -4 -27 -4 -4 -1 -35 -23 -70 -50 -63 -49
-88 -69 -159 -128 -19 -16 -93 -74 -163 -129 -70 -54 -145 -112 -166 -129 -21
-16 -54 -43 -74 -58 -21 -17 -57 -32 -89 -38 -125 -23 -119 -23 -713 6 -317
16 -447 27 -482 41 -17 8 -44 33 -60 56 -47 70 -140 101 -180 59 -10 -10 -37
-30 -60 -45 -74 -46 -90 -98 -45 -144 9 -10 23 -30 31 -44 25 -49 63 -76 116
-83 44 -5 55 -3 85 19 69 50 74 51 280 50 107 -1 233 -4 280 -7 47 -3 216 -11
375 -17 160 -6 316 -16 347 -22 54 -10 61 -15 100 -67 24 -31 70 -90 103 -131
34 -41 78 -99 100 -127 21 -29 43 -53 47 -53 4 0 8 -6 8 -14 0 -8 26 -43 57
-79 32 -36 73 -83 90 -105 37 -45 89 -65 107 -40 6 8 43 41 81 73 110 92 377
326 410 360 54 54 97 62 290 49 485 -33 747 -44 1144 -49 406 -5 401 -4 401
-51 0 -12 13 -36 29 -53 26 -28 32 -30 57 -21 36 14 54 6 54 -24 0 -14 14 -61
30 -106 83 -226 305 -458 545 -570 156 -73 296 -93 451 -65 296 53 544 236
703 517 118 209 125 499 19 751 -16 39 -38 81 -47 92 -9 11 -25 37 -36 59 -11
21 -25 41 -32 43 -7 3 -13 10 -13 17 0 25 -168 184 -228 216 -21 11 -45 25
-54 30 -10 6 -26 14 -35 20 -95 53 -249 90 -373 89 -52 0 -99 -2 -105 -4z"/>
<path d="M2388 3 c1317 -2 3468 -2 4780 0 1313 1 236 2 -2393 2 -2629 0 -3703
-1 -2387 -2z"/>
</g>
</svg>`;
  // 3) –Ø—Ä—Å/–û—Ä—î—à–Ω–∏–∫
  if(typeNorm.includes("—è—Ä—Å") || typeNorm.includes("–æ—Ä—î—à") || typeNorm.includes("–æ—Ä–µ—à") || typeNorm.includes("yars")) return `<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 viewBox="0 0 975.000000 944.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,944.000000) scale(0.100000,-0.100000)"
fill="currentColor" stroke="none">
<path d="M9745 4720 c0 -2599 1 -3662 2 -2363 2 1300 2 3426 0 4725 -1 1300
-2 237 -2 -2362z"/>
<path d="M2189 6952 c-18 -6 -55 -47 -81 -92 -11 -19 -32 -52 -46 -73 -14 -20
-22 -40 -19 -44 4 -3 -5 -14 -18 -25 -14 -11 -25 -24 -25 -29 0 -5 -15 -28
-33 -51 -17 -24 -44 -70 -59 -103 -26 -59 -27 -67 -29 -260 -1 -110 2 -265 6
-344 6 -127 5 -145 -9 -153 -15 -8 -17 -68 -16 -636 0 -345 0 -631 0 -637 0
-5 0 -458 0 -1006 0 -879 -1 -998 -15 -1009 -11 -9 -15 -32 -15 -86 0 -63 3
-75 20 -84 11 -6 20 -17 20 -26 0 -8 11 -37 25 -64 28 -55 33 -126 14 -191
-16 -51 10 -96 71 -126 42 -21 58 -22 277 -23 141 0 243 4 260 11 42 15 73 49
73 78 0 62 31 98 43 51 5 -19 14 -20 122 -20 l116 0 17 -32 c91 -170 280 -218
424 -107 20 16 41 29 47 29 13 0 23 17 26 44 1 11 3 24 4 29 3 16 17 4 41 -34
48 -79 140 -129 233 -129 90 1 196 64 233 139 22 48 29 50 38 15 11 -41 94
-117 151 -137 118 -41 245 -1 316 100 l36 52 35 -52 c46 -70 134 -117 216
-117 60 0 163 40 191 73 7 10 19 17 27 17 19 0 44 40 44 72 0 15 5 30 10 33 6
3 147 3 315 -1 l305 -7 25 -42 c71 -122 219 -177 338 -126 59 25 119 80 141
129 l18 39 141 6 c78 4 174 7 213 7 l70 0 17 -35 c66 -139 230 -202 362 -140
57 28 121 90 136 135 9 26 14 28 87 34 51 4 81 11 88 21 9 12 36 15 132 15
128 0 152 4 152 26 0 8 7 14 15 14 9 0 21 11 27 25 10 23 17 25 74 25 78 0 84
8 84 115 0 67 -3 79 -24 98 -31 29 -39 82 -40 278 -1 138 -3 159 -20 178 -18
19 -32 21 -270 26 -362 8 -1781 15 -3266 16 -839 1 -1300 4 -1327 11 l-43 10
0 1225 c0 1358 5 1268 -66 1298 l-36 15 3 572 4 573 -22 35 c-12 19 -36 61
-54 93 -18 32 -41 63 -51 68 -10 5 -18 17 -18 26 0 22 -63 123 -99 157 -27 26
-38 29 -100 30 -38 1 -75 0 -82 -2z"/>
</g>
</svg>`;
  // 4) –ì–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä
  if(typeNorm.includes("–≥–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä") || typeNorm.includes("helicopter")) return `<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 viewBox="0 0 1033.000000 942.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,942.000000) scale(0.100000,-0.100000)"
fill="currentColor" stroke="none">
<path d="M10325 4710 c0 -2593 1 -3654 2 -2357 2 1296 2 3418 0 4715 -1 1296
-2 235 -2 -2358z"/>
<path d="M3880 8301 c-8 -5 -46 -19 -83 -32 -47 -16 -78 -34 -97 -56 -31 -35
-31 -39 8 -163 12 -36 33 -105 48 -155 26 -90 58 -196 94 -310 10 -33 30 -100
45 -150 15 -49 35 -115 45 -145 10 -30 32 -102 50 -160 50 -167 90 -300 110
-365 11 -33 29 -94 41 -135 11 -41 32 -109 45 -150 13 -41 24 -81 24 -89 0 -9
6 -33 14 -56 8 -22 29 -87 46 -145 17 -58 42 -136 54 -175 61 -183 100 -325
98 -354 -4 -48 -25 -59 -120 -60 -396 -4 -613 -17 -937 -57 -65 -8 -232 -43
-283 -60 -26 -9 -84 -34 -130 -56 l-83 -40 -547 8 c-745 12 -697 13 -724 -14
-21 -21 -23 -31 -23 -143 l0 -121 31 -28 32 -28 258 -6 c143 -4 399 -11 569
-16 171 -6 373 -10 449 -10 120 0 152 -4 220 -25 137 -41 735 -95 1069 -95
137 0 207 -4 207 -10 0 -6 21 -33 47 -61 l46 -50 -23 -72 c-12 -40 -44 -139
-71 -222 -26 -82 -73 -231 -104 -330 -31 -99 -65 -205 -75 -235 -10 -30 -21
-71 -25 -90 -4 -19 -20 -69 -35 -110 -24 -66 -58 -172 -169 -525 -16 -49 -47
-151 -71 -225 -23 -74 -46 -144 -50 -155 -5 -11 -27 -81 -50 -155 -23 -74 -61
-196 -86 -271 -49 -150 -52 -177 -26 -209 17 -21 190 -80 238 -80 32 0 78 59
101 130 120 377 147 462 162 505 18 49 63 195 96 305 8 30 20 64 24 75 5 11
33 94 62 185 29 91 58 179 65 195 16 40 59 177 59 190 0 6 3 15 6 20 3 6 32
91 63 190 31 99 61 188 67 197 5 10 9 24 9 32 0 8 5 27 12 41 11 24 15 25 91
25 72 0 78 -2 72 -17 -21 -48 -17 -80 14 -115 39 -44 81 -53 241 -49 103 3
120 1 150 -18 88 -53 148 -53 190 -2 64 77 70 89 70 136 0 38 6 54 30 82 39
44 42 116 7 160 -28 34 -24 61 9 69 39 10 57 0 222 -124 35 -26 73 -52 84 -59
21 -11 33 -20 173 -123 42 -30 98 -71 126 -90 28 -19 81 -57 119 -85 38 -27
91 -65 117 -83 80 -55 294 -208 358 -255 33 -25 95 -69 138 -98 167 -116 194
-135 232 -166 22 -18 44 -33 48 -33 5 0 31 -18 57 -40 66 -55 86 -53 149 16
29 31 58 71 65 88 7 17 20 37 29 45 29 23 20 60 -22 100 -35 33 -139 112 -179
136 -10 5 -38 27 -64 47 -26 21 -51 38 -55 38 -5 0 -34 22 -65 50 -31 27 -60
50 -65 50 -5 0 -27 15 -49 33 -21 19 -49 39 -61 46 -12 6 -49 34 -82 61 -33
28 -63 50 -67 50 -4 0 -27 15 -51 33 -24 17 -75 55 -112 82 -37 28 -75 55 -84
60 -30 19 -102 70 -161 115 -32 25 -88 65 -125 90 -36 25 -93 65 -125 90 -32
25 -66 50 -75 55 -9 6 -35 25 -58 43 -22 17 -44 32 -47 32 -4 0 -38 25 -76 55
-38 30 -73 55 -78 55 -15 0 -62 56 -62 75 0 10 -10 29 -22 42 -12 13 -20 24
-17 26 2 2 79 11 171 21 91 9 181 21 200 26 33 9 287 48 448 69 47 6 135 14
195 16 61 3 151 9 200 15 216 22 323 28 616 36 l246 6 6 -169 c8 -198 17 -236
65 -280 32 -29 42 -33 94 -33 78 0 132 18 169 56 25 26 34 48 47 118 l17 86
218 0 218 0 24 -27 c33 -40 131 -70 175 -54 18 6 47 11 65 11 22 0 40 10 65
35 l34 35 247 0 247 0 31 26 c26 22 31 33 31 70 0 39 -4 47 -32 64 -31 18 -51
20 -276 20 -268 0 -259 -3 -199 61 20 21 38 27 90 33 120 12 171 47 165 113
-3 33 -8 40 -41 56 -20 11 -68 23 -105 29 -37 5 -110 21 -163 34 -84 21 -104
23 -170 14 -85 -11 -373 -13 -506 -4 l-90 7 -12 106 c-17 146 -39 257 -59 300
-24 50 -77 74 -167 75 -146 2 -171 -39 -181 -298 l-7 -175 -143 4 c-79 3 -210
7 -291 10 -163 5 -483 30 -898 71 -27 2 -93 13 -145 24 -52 11 -111 22 -130
24 -19 3 -66 12 -105 20 -38 9 -122 20 -185 26 -63 5 -135 13 -159 16 l-43 6
24 26 c14 15 28 34 31 43 3 9 36 37 74 62 37 26 79 56 93 67 14 11 29 20 34
20 4 0 30 18 56 40 26 22 51 40 54 40 4 0 36 21 71 48 121 89 160 117 170 121
5 2 38 26 71 52 34 27 66 49 70 49 5 0 26 16 47 35 21 19 41 35 44 35 3 0 22
12 42 28 20 15 43 32 52 37 10 6 65 45 124 88 58 42 109 77 113 77 3 0 17 11
31 24 15 13 40 32 57 43 28 16 90 61 200 142 23 17 44 31 48 31 4 0 32 20 60
45 29 25 57 45 62 45 5 0 31 18 58 40 26 22 52 40 57 40 4 0 24 14 44 31 61
53 46 97 -85 252 -41 47 -80 50 -136 7 -21 -16 -43 -30 -48 -30 -4 0 -29 -17
-55 -38 -25 -21 -53 -41 -61 -44 -8 -3 -41 -26 -72 -52 -31 -25 -61 -46 -66
-46 -5 0 -20 -10 -33 -23 -21 -20 -78 -61 -128 -92 -9 -5 -44 -31 -78 -57 -35
-27 -65 -48 -69 -48 -3 0 -23 -12 -43 -27 -20 -16 -43 -32 -52 -38 -42 -26
-108 -73 -144 -101 -22 -18 -54 -40 -71 -50 -61 -37 -172 -115 -184 -129 -7
-8 -17 -15 -23 -15 -6 0 -31 -17 -56 -38 -25 -21 -57 -45 -71 -52 -14 -7 -44
-28 -67 -46 -23 -19 -45 -34 -50 -34 -4 0 -19 -10 -33 -21 -14 -11 -50 -37
-80 -57 -31 -21 -69 -48 -85 -60 -29 -22 -32 -22 -72 -6 -51 20 -59 38 -33 71
15 20 20 41 20 90 0 55 -4 67 -25 89 -20 20 -25 35 -25 74 0 38 -6 56 -24 77
-14 16 -36 41 -49 57 -20 24 -33 30 -78 34 -48 4 -59 1 -86 -22 -17 -14 -38
-26 -46 -26 -9 0 -19 -4 -22 -10 -8 -13 -120 -13 -165 0 -58 17 -145 -7 -182
-49 -27 -31 -30 -39 -25 -83 l6 -48 -67 2 c-76 2 -108 -11 -123 -49 -16 -43
-17 -41 -89 197 -17 58 -40 128 -50 155 -10 28 -35 104 -55 170 -20 66 -49
163 -65 215 -70 230 -100 329 -116 385 -9 33 -23 80 -31 105 -21 63 -62 196
-78 250 -7 25 -41 135 -75 245 -34 110 -66 215 -72 234 -19 66 -86 101 -138
72z m4694 -3213 c3 -13 6 -26 6 -30 0 -5 -92 -8 -205 -8 l-205 0 0 25 0 24
138 3 c75 2 165 4 198 6 57 2 62 0 68 -20z"/>
</g>
</svg>`;
  // 5) –ë–ø–õ–ê (–∑–∞–≥–∞–ª—å–Ω–∏–π)
  if(typeNorm === "–±–ø–ª–∞") return `<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 viewBox="0 0 321.000000 305.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,305.000000) scale(0.100000,-0.100000)"
fill="currentColor" stroke="none">
<path d="M0 3035 c0 -13 184 -15 1600 -15 l1600 0 0 -1500 0 -1500 -1600 0
c-1060 0 -1600 -3 -1600 -10 0 -7 542 -10 1605 -10 l1605 0 0 1525 0 1525
-1605 0 c-1420 0 -1605 -2 -1605 -15z"/>
<path d="M2331 2525 c-30 -18 -58 -25 -93 -25 -43 0 -58 -5 -92 -33 -64 -52
-226 -168 -226 -161 0 3 -24 -14 -52 -39 -29 -24 -106 -84 -172 -132 -108 -80
-122 -88 -161 -87 -50 2 -87 -27 -66 -52 10 -12 3 -22 -45 -58 -31 -24 -76
-59 -98 -79 -38 -32 -109 -86 -242 -182 l-52 -37 -128 0 c-261 0 -426 -37
-487 -109 -36 -43 -34 -63 8 -110 60 -66 129 -82 387 -91 l218 -7 72 -55 c40
-29 93 -66 118 -80 25 -15 94 -63 155 -107 l110 -81 -62 0 c-45 0 -67 -5 -84
-19 -23 -19 -24 -19 -5 -40 17 -19 30 -21 135 -21 127 0 114 4 231 -80 34 -25
72 -52 84 -60 12 -8 64 -47 116 -85 52 -39 106 -78 120 -88 14 -9 60 -41 102
-71 64 -44 87 -55 135 -61 32 -4 73 -16 91 -27 29 -18 46 -20 122 -16 68 3 94
8 110 23 25 23 25 37 0 60 -19 17 -20 31 -20 399 0 347 1 379 16 358 19 -28
45 -28 70 -1 16 18 18 37 17 152 -2 200 -9 276 -29 298 -9 10 -22 19 -29 19
-20 0 -45 -35 -46 -66 -1 -16 -5 -4 -9 26 -4 30 -5 210 -2 400 4 320 6 347 23
366 49 53 7 84 -111 84 -72 0 -92 -4 -129 -25z"/>
</g>
</svg>`;
  // 6) –£–¥–∞—Ä–Ω–∏–π/—Ä–æ–∑–≤—ñ–¥ –ë–ø–õ–ê
  if(typeNorm.includes("—É–¥–∞—Ä–Ω–∏–π/—Ä–æ–∑–≤—ñ–¥") || (typeNorm.includes("—Ä–æ–∑–≤—ñ–¥") && typeNorm.includes("–±–ø–ª–∞"))) return `<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 viewBox="0 0 63.000000 62.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,62.000000) scale(0.100000,-0.100000)"
fill="currentColor" stroke="none">
<path d="M4 310 c0 -173 2 -244 3 -157 2 86 2 228 0 315 -1 86 -3 15 -3 -158z"/>
<path d="M270 445 l0 -105 -94 0 c-71 0 -97 -4 -106 -15 -10 -12 -10 -18 0
-30 9 -11 35 -15 106 -15 l94 0 0 -105 0 -105 30 0 30 0 0 105 0 105 99 0 100
0 3 -32 c2 -22 9 -34 21 -36 13 -3 17 4 17 32 0 26 5 36 20 41 26 8 26 42 0
50 -14 4 -20 15 -20 36 0 40 -34 37 -38 -4 l-3 -27 -100 0 -99 0 0 105 0 105
-30 0 -30 0 0 -105z"/>
</g>
</svg>`;
  // 7) –†–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä (–Ω–æ–≤–∞ —Ü—ñ–ª—å)
  if(typeNorm.includes("—Ä–µ—Ç—Ä–∞–Ω—Å")) return `<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 viewBox="0 0 875.000000 876.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,876.000000) scale(0.100000,-0.100000)"
fill="currentColor" stroke="none">
<path d="M2 4383 l-2 -4383 4378 2 4377 3 -4372 2 -4373 3 -3 4378 -2 4377 -3
-4382z"/>
<path d="M6378 7295 c-37 -8 -104 -31 -150 -53 -147 -68 -231 -129 -1563
-1127 l-670 -503 -110 -5 c-119 -5 -188 -22 -193 -49 -2 -12 9 -19 48 -27 28
-6 69 -11 91 -11 23 0 38 -4 34 -10 -3 -5 -216 -175 -473 -377 -257 -201 -484
-380 -504 -396 l-37 -30 -238 -13 c-131 -7 -329 -18 -441 -23 -211 -12 -400
-37 -513 -70 -245 -70 -354 -205 -305 -376 55 -188 337 -287 901 -315 116 -6
295 -15 398 -21 l189 -10 266 -202 c301 -227 419 -320 609 -481 l132 -111 -76
-12 c-85 -13 -108 -27 -80 -48 25 -18 129 -35 218 -35 l74 0 185 -142 c1237
-947 1906 -1393 2325 -1549 l90 -34 458 -3 457 -3 0 61 0 60 -149 0 -148 0 -7
31 c-3 17 -6 133 -6 258 0 124 -3 236 -6 248 l-6 23 -290 2 -289 3 -427 795
c-235 437 -451 839 -481 894 l-53 99 28 -7 c160 -35 284 -30 428 18 198 67
356 224 417 416 27 84 29 228 5 319 -71 266 -315 459 -606 478 -95 6 -204 -8
-286 -36 l-54 -19 11 20 c50 94 1012 1805 1018 1811 5 5 142 8 305 7 l296 -1
0 184 c0 101 3 205 6 231 l7 46 148 0 149 0 0 24 c0 13 -3 38 -6 55 l-6 31
-527 -1 c-395 -1 -543 -4 -593 -14z"/>
<path d="M6776 5849 c-43 -77 -77 -141 -75 -143 2 -2 24 -14 49 -26 130 -65
277 -176 406 -304 232 -232 368 -483 430 -791 26 -128 26 -426 0 -545 -96
-446 -363 -812 -765 -1049 -47 -28 -92 -54 -98 -58 -9 -6 7 -42 56 -131 38
-68 73 -128 78 -133 12 -12 107 38 238 124 706 465 1015 1294 769 2059 -69
217 -195 444 -340 619 -159 191 -392 377 -610 487 l-60 30 -78 -139z"/>
<path d="M6469 5283 c-41 -72 -68 -128 -62 -130 24 -8 151 -102 205 -152 82
-75 144 -161 199 -276 66 -138 80 -196 86 -355 4 -122 2 -145 -21 -235 -60
-232 -196 -420 -412 -565 -43 -29 -78 -58 -76 -64 3 -11 133 -247 151 -274 7
-11 17 -10 52 8 121 61 262 179 368 306 364 437 378 1031 36 1485 -102 136
-243 259 -407 352 l-47 27 -72 -127z"/>
</g>
</svg>`;
  // 8) –ú—ñ–ì-31–ö
  if(typeNorm.includes("–º—ñ–≥-31–∫") || typeNorm.includes("mig-31k")) return `<svg
   version="1.1"
   id="svg1"
  
  
   viewBox="0 0 64 64"
   sodipodi:docname="mig31k.svg"
   inkscape:version="1.3.2 (091e20e, 2023-11-25, custom)"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg">
  <defs
     id="defs1" />
  <sodipodi:namedview
     id="namedview1"
     pagecolor="#ffffff"
     bordercolor="#000000"
     borderopacity="0.25"
     inkscape:showpageshadow="2"
     inkscape:pageopacity="0.0"
     inkscape:pagecheckerboard="0"
     inkscape:deskcolor="#d1d1d1"
     showguides="true"
     inkscape:zoom="6.0104076"
     inkscape:cx="11.14733"
     inkscape:cy="36.270418"
     inkscape:window-width="1440"
     inkscape:window-height="740"
     inkscape:window-x="-6"
     inkscape:window-y="-6"
     inkscape:window-maximized="1"
     inkscape:current-layer="g1">
    <sodipodi:guide
       position="17.176471,33.764706"
       orientation="1,0"
       id="guide1"
       inkscape:locked="false" />
  </sodipodi:namedview>
  <g
     inkscape:groupmode="layer"
     inkscape:label="Image"
     id="g1">
    <path
       style="fill:#000000"
       d="m 40.74353,50.424824 c 0,-0.351734 0.793597,-0.674236 1.659127,-0.674236 0.521974,0 0.255311,-0.447689 -1.381891,-2.32 -5.339244,-6.105979 -7.48562,-8.429702 -8.094315,-8.763116 -0.364607,-0.199714 -1.454921,-0.46379 -2.422921,-0.586836 -0.968,-0.123046 -2.624,-0.44771 -3.68,-0.721475 -1.056,-0.273765 -3.648,-0.585689 -5.76,-0.693164 l -3.898824,-0.224821 c -0.01193,-0.65773 -0.0064,-1.315437 -0.0025,-1.973198 L 13.926691,34.268527 C 10.92061,34.083219 6.3892344,33.383038 4.4257557,32.84714 3.4750725,32.587668 3.4794614,32.582842 5.0186161,32.195279 8.2208543,31.388946 11.871541,30.882191 14.519274,30.876484 l 2.618097,0.02351 c 0.02535,-0.726727 0.01777,-1.453389 0.01188,-2.180299 l 3.803607,-0.248868 c 2.172036,-0.142115 5.017702,-0.505531 6.321855,-0.837204 1.304153,-0.331672 2.93362,-0.603041 3.621037,-0.603041 0.687417,0 1.492396,-0.129807 1.788843,-0.28846 0.562656,-0.301125 10.059311,-10.731502 10.245599,-11.252959 0.05867,-0.16422 -0.409334,-0.298581 -1.04,-0.298581 -0.630667,0 -1.146667,-0.144 -1.146667,-0.32 0,-0.198621 1.76,-0.32 4.64,-0.32 4.413676,0 5.030059,0.115874 4.340656,0.816 -0.537867,0.546232 -3.498752,12.944 -3.091339,12.944 0.753472,0 2.698213,-1.202625 5.843949,-3.613889 1.769509,-1.356361 3.356313,-2.466111 3.526231,-2.466111 0.341266,0 1.700503,1.355492 1.700503,1.695817 0,0.118013 -0.419136,0.900732 -0.931414,1.739376 -0.512277,0.838644 -0.980277,1.884807 -1.04,2.324807 -0.09728,0.716691 0.01638,0.810343 1.091414,0.899317 l 1.2,0.09932 v 3.66068 3.660683 h -1.286097 c -1.239393,0 -1.27865,0.03196 -1.081034,0.88 0.112785,0.484 0.619528,1.540607 1.126097,2.348015 0.506569,0.807408 0.921034,1.610307 0.921034,1.78422 0,0.366225 -1.360405,1.707765 -1.73178,1.707765 -0.137792,0 -1.496511,-0.977519 -3.019376,-2.172263 -3.896901,-3.057267 -4.670064,-3.567981 -5.719169,-3.777802 l -0.924187,-0.184837 1.520431,6.187451 c 0.836237,3.403098 1.663527,6.423926 1.838422,6.712951 0.174896,0.289026 0.230467,0.613026 0.123492,0.72 -0.31196,0.311961 -9.047833,0.223843 -9.047833,-0.09126 z"
       id="path1"
       sodipodi:nodetypes="sssssssccssssccsssssssssssssssscccssssssscsssss" />
  </g>
</svg>`;
  return null;
}

const svgOverride = pickSvgByType();
    const svgFixed = svgOverride ? svgOverride.replace(/<svg\s+/i, '<svg width="100%" height="100%" style="width:100%;height:100%;display:block;" ') : "";
  const isShahed = type.includes("—à–∞—Ö–µ–¥") || type.includes("shahed");
  const baseHeading = Number(t.heading ?? 0);
  // –ù–∞—à—ñ SVG-—ñ–∫–æ–Ω–∫–∏ –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω—ñ –ø–µ—Ä–µ–≤–∞–∂–Ω–æ "–Ω–æ—Å–æ–º –≤–ª—ñ–≤–æ" (–Ω–∞ –∑–∞—Ö—ñ–¥).
  // –ê –∫—É—Ä—Å —É –Ω–∞—Å: 0¬∞ = –ü—ñ–≤–Ω—ñ—á, 90¬∞ = –°—Ö—ñ–¥. –©–æ–± "–Ω—ñ—Å = –ø–∞–ª–∫–∞", —Ä–æ–±–∏–º–æ –∑—Å—É–≤.
  // –Ø–∫—â–æ —ñ–∫–æ–Ω–∫–∞ –¥–∏–≤–∏—Ç—å—Å—è –í–õ–Ü–í–û (–∑–∞—Ö—ñ–¥) => offset = +90 (–±–æ –ø—Ä–∏ –∫—É—Ä—Å—ñ 90¬∞ —Ç—Ä–µ–±–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –Ω–∞ 180¬∞).
  // –Ø–∫—â–æ —ñ–∫–æ–Ω–∫–∞ –¥–∏–≤–∏—Ç—å—Å—è –í–ü–†–ê–í–û (—Å—Ö—ñ–¥) => offset = -90.
  function iconOffsetByType(typeStr){
    const t = (typeStr||"").toLowerCase();
    // –í—Å—ñ —Ç–≤–æ—ó –ø–æ—Ç–æ—á–Ω—ñ SVG (Shahed, TA, —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä, —Ç–æ—â–æ) –¥–∏–≤–ª—è—Ç—å—Å—è –í–õ–Ü–í–û
    // ‚Äî —Ç–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ +90. –Ø–∫—â–æ –¥–æ–¥–∞—Å–∏ SVG —â–æ –¥–∏–≤–∏—Ç—å—Å—è –≤–ø—Ä–∞–≤–æ ‚Äî –¥–æ–¥–∞–º–æ —Å—é–¥–∏.
    if(t.includes("—Ç–∞–∫—Ç–∏—á") || t.includes("ta") || t.includes("—à–∞—Ö–µ–¥") || t.includes("shahed") ||
       t.includes("—Ä–µ—Ç—Ä–∞–Ω—Å") || t.includes("retrans") || t.includes("—Ö-101") || t.includes("x101") || t.includes("—Ö101") ||
       t.includes("–∫–æ—Ä–∞–±") || t.includes("–Ω–µ–≤—Å") || t.includes("–Ω–µ–≤—Å—Ç") || t.includes("—Ç—É-160") || t.includes("tu-160") ||
       t.includes("—è—Ä—Å") || t.includes("–æ—Ä—î—à") || t.includes("–æ—Ä–µ—à") || t.includes("–º—ñ–≥") || t.includes("mig") ||
       t.includes("–≥–µ–ª—ñ–∫") || t.includes("helic") || t.includes("–±–ø–ª–∞"))
      return +90;
    return +90;
  }
  const iconOffset = iconOffsetByType(type);
  const heading = baseHeading + iconOffset;


function makeSvgDivIcon(svgMarkup, sizePx, heading){
  const glow = state.glow ? `filter: drop-shadow(0 0 10px rgba(255,255,255,0.35));` : "";
  const colored = (svgMarkup||"").replace(/<svg\s+/i, '<svg width="100%" height="100%" style="width:100%;height:100%;display:block;" ');
  const html = `
    <div style="width:${sizePx}px;height:${sizePx}px;display:flex;align-items:center;justify-content:center;transform: rotate(${heading}deg); transform-origin:50% 50%; color:#000000; ${glow}">
      <div style="width:${Math.round(sizePx*0.95)}px;height:${Math.round(sizePx*0.95)}px;">${colored}</div>
    </div>`;
  return L.divIcon({ className:"", html, iconSize:[sizePx,sizePx], iconAnchor:[sizePx/2, sizePx/2] });
}

// If we have a custom icon for this type, use it (except Shahed which has its own detailed SVG).
if(svgOverride){
  return makeSvgDivIcon(svgOverride, sizePx, heading);
}

  

  // default: circle
  const circle = `
    <div style="
      width:${sizePx}px;height:${sizePx}px;border-radius:50%;
      border:2px solid rgba(0,0,0,0.45);
      background:${state.iconColor};
      ${state.glow ? "box-shadow: 0 0 14px 4px rgba(255,255,255,0.35);" : ""}
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:${Math.max(10, Math.floor(sizePx*0.42))}px;
      color:#000;
    ">‚Ä¢</div>`;
  return L.divIcon({ className:"", html: circle, iconSize:[sizePx,sizePx], iconAnchor:[sizePx/2, sizePx/2] });
}


function makeLabelHtml(t){
  const show = state.labelsOn;
  if(!show) return "";
  const name = (t.name?.trim() ? t.name.trim() : t.type);
  const count = Number(t.count||1);
  const txt = count>1 ? `${name} √ó${count}` : name;

  const bg = state.labelBgOn ? `background:${hexToRgba(state.labelBg, 0.55)}; padding:2px 6px; border-radius:10px; border:1px solid rgba(255,255,255,0.12);` : "";
  return `<div style="
      color:${state.labelColor};
      font-weight:900;
      font-size:${state.labelSize}px;
      white-space:nowrap;
      ${bg}
    ">${escapeHtml(txt)}</div>`;
}

function hexToRgba(hex, a){
  const h = hex.replace("#","");
  const r = parseInt(h.substring(0,2),16);
  const g = parseInt(h.substring(2,4),16);
  const b = parseInt(h.substring(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}
function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function dynIconSize(){
  const base = Number(state.iconSize||30);
  if(!state.dynSize) return base;
  const z = map.getZoom();
  // map zoom 5..12 typical => 0.75..1.35
  const k = clamp(0.55 + (z/12), 0.75, 1.35);
  return Math.round(base * k);
}

// Threat sector drawing (circle sector as polygon)
function sectorPolygon(lat,lng, radiusKm, headingDeg, angleDeg, steps=40){
  const r = kmToMeters(radiusKm);
  const half = angleDeg/2;
  const pts = [];
  pts.push([lat,lng]);
  for(let i=0;i<=steps;i++){
    const b = headingDeg - half + (angleDeg*(i/steps));
    const p = destinationPoint(lat,lng, b, r);
    pts.push([p.lat,p.lng]);
  }
  pts.push([lat,lng]);
  return pts;
}

function addTargetLayers(t){
  const size = dynIconSize();
  const marker = L.marker([t.lat,t.lng], { draggable:true, icon: makeIconForTarget(t, size) }).addTo(map);

  const label = L.marker([t.lat,t.lng], {
    interactive:false,
    icon: L.divIcon({ className:"", html: makeLabelHtml(t), iconAnchor:[-10, -10] })
  }).addTo(map);

  const idLabel = L.marker([t.lat,t.lng], {
    interactive:false,
    icon: L.divIcon({ className:"", html: "", iconAnchor:[-10, 22] })
  }).addTo(map);

  const dirEnd = destinationPoint(t.lat, t.lng, t.heading ?? 90, kmToMeters(35));
  const dirLine = L.polyline([[t.lat,t.lng],[dirEnd.lat,dirEnd.lng]], { weight:3, opacity:0.85 }).addTo(map);

  const traj = L.polyline([], { weight: state.trajWidth, opacity: state.trajOpacity }).addTo(map);
  const turnPoints = L.layerGroup().addTo(map);

  const threatSector = L.polygon(sectorPolygon(t.lat,t.lng, t.threatRadius||0, t.heading||0, t.threatAngle||90), {
    weight:1,
    opacity:0.35,
    fillOpacity:0.12
  }).addTo(map);

  layersById.set(String(t.id), { marker, label, dirLine, traj, turnPoints, threatSector, idLabel });

  marker.on("drag", (ev) => {
    const ll = ev.target.getLatLng();
    t.lat = ll.lat; t.lng = ll.lng;
    refreshTarget(t);
    save();
    renderList();
  });

  marker.on("click", (ev) => openTargetMenu(t, ev));

  refreshTarget(t);
}

function refreshTarget(t){
  const ls = layersById.get(String(t.id));
  if(!ls) return;

  // icon size and color
  ls.marker.setIcon(makeIconForTarget(t, dynIconSize()));

  // label & id label
  ls.label.setIcon(L.divIcon({ className:"", html: makeLabelHtml(t), iconAnchor:[-10, -10] }));

  const idHtml = state.showId ? `<div style="color:${state.idColor}; font-weight:1000; font-size:${state.idSize}px; ${state.labelBgOn ? "background:rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.10); padding:1px 6px; border-radius:999px;" : ""}">${escapeHtml(t._idText||"")}</div>` : "";
  ls.idLabel.setIcon(L.divIcon({ className:"", html: idHtml, iconAnchor:[-10, 22] }));

  // move labels with marker
  const ll = ls.marker.getLatLng();
  ls.label.setLatLng(ll);
  ls.idLabel.setLatLng(ll);

  // direction line
  if(state.dirLineOn){
    const end = destinationPoint(t.lat, t.lng, t.heading ?? 0, kmToMeters(35));
    ls.dirLine.setLatLngs([[t.lat,t.lng],[end.lat,end.lng]]);
    ls.dirLine.setStyle({ opacity: 0.85 });
  } else {
    ls.dirLine.setStyle({ opacity: 0 });
  }

  // trajectory
  if(state.trajOn){
    const latlngs = (t.trajectory||[]).map(p => [p.lat,p.lng]);
    ls.traj.setLatLngs(latlngs);
    const dash = state.trajStyle==="dash" ? "8 8" : null;
    ls.traj.setStyle({
      color: state.trajColor,
      weight: Number(state.trajWidth||3),
      opacity: Number(state.trajOpacity||0.9),
      dashArray: dash
    });
  } else {
    ls.traj.setLatLngs([]);
  }

  // turn points
  ls.turnPoints.clearLayers();
  if(state.showTurnPoints && (t.points||[]).length){
    for(const p of t.points){
      L.circleMarker([p.lat,p.lng], { radius:4, weight:1, fillOpacity:0.7 }).addTo(ls.turnPoints);
    }
  }

  // threat sector
  const status = t.status;
  const col = (status==="threat" || status==="acousticThreat") ? "#ff4d4d" :
              (status==="acoustic") ? "#6fe3ff" :
              (status==="stop") ? "#ffd54a" : "#49d17d";

  if(state.hideThreats || (t.threatRadius||0)<=0){
    ls.threatSector.setStyle({ opacity:0, fillOpacity:0 });
  } else {
    ls.threatSector.setLatLngs(sectorPolygon(t.lat,t.lng, t.threatRadius||0, t.heading||0, t.threatAngle||90));
    ls.threatSector.setStyle({ color: col, fillColor: col, opacity: 0.35, fillOpacity: 0.12 });
  }

  // popup
  const title = (t.name?.trim() ? t.name.trim() : t.type);
  const pausedTxt = t.paused ? " (–ø–∞—É–∑–∞)" : "";
  ls.marker.bindPopup(`
    <div style="min-width:210px">
      <div style="font-weight:1000;margin-bottom:4px">${escapeHtml(title)}${pausedTxt}</div>
      <div style="font-size:12px;opacity:.85">–°—Ç–∞—Ç—É—Å: ${statusText(t.status)}</div>
      <div style="font-size:12px;opacity:.85">–ö—É—Ä—Å: ${t.heading ?? 0}¬∞ ‚Ä¢ –®–≤–∏–¥–∫: ${t.speed ?? 0} –∫–º/–≥–æ–¥</div>
      <div style="font-size:12px;opacity:.85">–ó–∞–≥—Ä–æ–∑–∞: R ${t.threatRadius ?? 0} –∫–º ‚Ä¢ ${t.threatAngle ?? 0}¬∞</div>
      <div style="font-size:12px;opacity:.75">–¢–∞–ø –ø–æ –º–∞—Ä–∫–µ—Ä—É ‚Üí –º–µ–Ω—é</div>
    </div>
  `);
}

// --- Context menu (simple modal-like prompt) ---

function openTargetMenu(t, ev){
  // Build and show a small clickable menu near the cursor
  const menu = $("targetMenu");
  const title = (t.name?.trim() ? t.name.trim() : t.type);
  menu.innerHTML = `
    <div class="title">${escapeHtml(title)}</div>
    <div class="mini">${escapeHtml(t.type)} ‚Ä¢ ${statusText(t.status)} ‚Ä¢ ${t.heading ?? 0}¬∞ ‚Ä¢ ${t.speed ?? 0} –∫–º/–≥–æ–¥</div>
    <div class="btnRow">
      <button data-act="speed">–®–≤–∏–¥–∫—ñ—Å—Ç—å</button>
      <button data-act="edit">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
      <button data-act="dir">–ù–æ–≤–∏–π –Ω–∞–ø—Ä—è–º–æ–∫</button>
      <button data-act="turn">–¢–æ—á–∫–∞ –ø–æ–≤–æ—Ä–æ—Ç—É</button>
      <button data-act="tp">–¢–µ–ª–µ–ø–æ—Ä—Ç</button>
      <button data-act="clone">–ö–ª–æ–Ω—É–≤–∞—Ç–∏</button>
      <button class="danger" data-act="del">–í–∏–¥–∞–ª–∏—Ç–∏</button>
    </div>
    <div class="sep"></div>
    <div id="menuSub"></div>
  `;

  // Position
  const wrap = $("mapWrap");
  const r = wrap.getBoundingClientRect();
  const ox = (ev && ev.originalEvent) ? ev.originalEvent.clientX : (r.left + 40);
  const oy = (ev && ev.originalEvent) ? ev.originalEvent.clientY : (r.top + 80);
  let x = ox - r.left + 10;
  let y = oy - r.top + 10;

  menu.style.display = "block";
  // clamp to viewport
  const w = menu.offsetWidth, h = menu.offsetHeight;
  x = Math.max(10, Math.min(x, r.width - w - 10));
  y = Math.max(10, Math.min(y, r.height - h - 10));
  menu.style.left = x + "px";
  menu.style.top  = y + "px";

  // stop leaflet click-through
  if(ev && ev.originalEvent){ ev.originalEvent.preventDefault?.(); ev.originalEvent.stopPropagation?.(); }

  const sub = () => menu.querySelector("#menuSub");

  const close = ()=>{ menu.style.display="none"; menu.innerHTML=""; };

  // close if click on map background
  setTimeout(()=>{
    const onDoc = (e)=>{
      if(!menu.contains(e.target)){ document.removeEventListener("mousedown", onDoc, true); close(); }
    };
    document.addEventListener("mousedown", onDoc, true);
  }, 0);

  menu.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act = btn.getAttribute("data-act");

      if(act==="speed"){
        const cur = Number(t.speed ?? 0);
        sub().innerHTML = `
          <div class="mini">–ü–æ—Ç–æ—á–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å: <b>${cur}</b> –∫–º/–≥–æ–¥</div>
          <div class="btnRow">
            <button data-step="-50">-50</button>
            <button data-step="-10">-10</button>
            <button data-step="+10">+10</button>
            <button data-step="+50">+50</button>
            <button data-step="preset:150">150</button>
            <button data-step="preset:250">250</button>
          </div>
        `;
        sub().querySelectorAll("button[data-step]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const v = b.getAttribute("data-step");
            let ns = Number(t.speed ?? 0);
            if(v.startsWith("preset:")) ns = Number(v.split(":")[1]);
            else ns = Math.max(0, ns + Number(v));
            t.speed = ns;
            save(); renderList(); refreshTarget(t);
            openTargetMenu(t, ev); // refresh menu
          });
        });
        return;
      }

      if(act==="edit"){ close(); editTarget(t); return; }

      if(act==="dir"){ close(); startSetDirection(t); toast("–ö–ª—ñ–∫–Ω–∏ –Ω–∞ –º–∞–ø—ñ: –Ω–æ–≤–∏–π –Ω–∞–ø—Ä—è–º–æ–∫"); return; }

      if(act==="turn"){ close(); startAddTurnPoint(t); toast("–ö–ª—ñ–∫–Ω–∏ –Ω–∞ –º–∞–ø—ñ: –¥–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É –ø–æ–≤–æ—Ä–æ—Ç—É"); return; }

      if(act==="tp"){
        close();
        pendingAction = { type:"teleportClick", targetId:t.id };
        toast("–ö–ª—ñ–∫–Ω–∏ –Ω–∞ –º–∞–ø—ñ: —Ç–µ–ª–µ–ø–æ—Ä—Ç —Ü—ñ–ª—ñ");
        return;
      }

      if(act==="clone"){
        close();
        pendingAction = { type:"cloneClick", targetId:t.id };
        toast("–ö–ª—ñ–∫–Ω–∏ –Ω–∞ –º–∞–ø—ñ: –¥–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–ª–æ–Ω");
        return;
      }

      if(act==="del"){
        close();
        deleteTarget(t, /*noConfirm*/ true);
        return;
      }
    });
  });
}


function editTarget(t){
  // load UI fields and apply
  $("type").value = t.type || "–®–∞—Ö–µ–¥";
  $("status").value = t.status || "move";
  $("name").value = t.name || "";
  $("count").value = t.count || 1;
  $("speed").value = t.speed ?? 150;
  $("rangeKm").value = t.rangeKm ?? 999;
  $("heading").value = t.heading ?? 90;
  $("threatRadius").value = t.threatRadius ?? 25;
  $("threatAngle").value = t.threatAngle ?? 90;

  alert("–ü–æ–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –≤ –ø–∞–Ω–µ–ª—å. –ó–º—ñ–Ω–∏ –∑–Ω–∞—á–µ–Ω–Ω—è —ñ –Ω–∞—Ç–∏—Å–Ω–∏ '–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –¥–æ –≤–∏–±—Ä–∞–Ω–æ—ó' —É —Å–ø–∏—Å–∫—É (–∫–Ω–æ–ø–∫–∞ –∑–Ω–∏–∑—É –≤ –∫–∞—Ä—Ç–æ—á—Ü—ñ —Ü—ñ–ª—ñ).");
}

// Add direction by map click
let pendingAction = null; // {type, targetId}
function startSetDirection(t){
  pendingAction = { type:"setDirection", targetId:t.id };
  alert("–ö–ª—ñ–∫–Ω–∏ –Ω–∞ –º–∞–ø—ñ, —â–æ–± –∑–∞–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –Ω–∞–ø—Ä—è–º–æ–∫.");
}
function startAddTurnPoint(t){
  pendingAction = { type:"addTurnPoint", targetId:t.id };
  alert("–ö–ª—ñ–∫–Ω–∏ –Ω–∞ –º–∞–ø—ñ, —â–æ–± –¥–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É –ø–æ–≤–æ—Ä–æ—Ç—É.");
}
map.on("click", (e) => {
  if(state.drawMode){ return; }
  if(state.addMode){
    // Two-click creation: 1) place target, 2) set direction
    if(state.addStep===0){
      state.addFirstLatLng = e.latlng;
      state.addStep = 1;
      $("btnAdd").textContent = "üü¢ –ö–ª—ñ–∫ 2: –Ω–∞–ø—Ä—è–º–æ–∫ —Ü—ñ–ª—ñ";
      return;
    }
    if(state.addStep===1 && state.addFirstLatLng){
      const br = bearing(state.addFirstLatLng.lat, state.addFirstLatLng.lng, e.latlng.lat, e.latlng.lng);
      const heading = Math.round((br+360)%360);
      createTargetAt(state.addFirstLatLng, heading);
      state.addFirstLatLng = null;
      state.addStep = 0;
      return;
    }
  }
  if(!pendingAction) return;
  const t = data.targets.find(x => x.id === pendingAction.targetId);
  if(!t){ pendingAction=null; return; }

  if(pendingAction.type==="setDirection"){
    const br = bearing(t.lat,t.lng, e.latlng.lat, e.latlng.lng);
    t.heading = Math.round((br+360)%360);
    pendingAction = null;
    refreshTarget(t); save(); renderList();
    return;
  }
  if(pendingAction.type==="addTurnPoint"){
    t.points = t.points || [];
    t.points.push({ lat: e.latlng.lat, lng: e.latlng.lng });
    pendingAction = null;
    refreshTarget(t); save(); renderList();
    return;
  }
  if(pendingAction.type==="teleportClick"){
    t.lat = e.latlng.lat; t.lng = e.latlng.lng;
    pendingAction = null;
    const ls = layersById.get(String(t.id));
    if(ls) ls.marker.setLatLng([t.lat,t.lng]);
    refreshTarget(t); save(); renderList();
    return;
  }
  if(pendingAction.type==="cloneClick"){
    const src = t;
    const c = JSON.parse(JSON.stringify(src));
    c.id = uid();
    c.createdAt = Date.now();
    c.lat = e.latlng.lat;
    c.lng = e.latlng.lng;
    data.targets.push(c);
    addTargetLayers(c);
    pendingAction = null;
    save(); renderList();
    return;
  }
});

function bearing(lat1,lng1,lat2,lng2){
  const œÜ1 = deg2rad(lat1), œÜ2=deg2rad(lat2);
  const ŒîŒª = deg2rad(lng2-lng1);
  const y = Math.sin(ŒîŒª)*Math.cos(œÜ2);
  const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
  return rad2deg(Math.atan2(y,x));
}

function teleportTarget(t){
  const mode = prompt("–¢–µ–ª–µ–ø–æ—Ä—Ç: –≤–≤–µ–¥–∏ 't' (–∑–∞ —á–∞—Å–æ–º) –∞–±–æ 'd' (–∑–∞ –≤—ñ–¥—Å—Ç–∞–Ω–Ω—é):", "t");
  if(!mode) return;

  if(mode.toLowerCase()==="t"){
    const min = Number(prompt("–•–≤–∏–ª–∏–Ω–∏:", "1")||"0");
    const sec = Number(prompt("–°–µ–∫—É–Ω–¥–∏:", "0")||"0");
    const totalH = (min*60+sec)/3600;
    const speed = Number(t.speed||0);
    const km = speed * totalH;
    const p = destinationPoint(t.lat,t.lng, t.heading||0, kmToMeters(km));
    t.lat = p.lat; t.lng = p.lng;
  } else {
    const km = Number(prompt("–ö—ñ–ª–æ–º–µ—Ç—Ä–∏:", "0")||"0");
    const m  = Number(prompt("–ú–µ—Ç—Ä–∏:", "0")||"0");
    const distM = kmToMeters(km) + m;
    const p = destinationPoint(t.lat,t.lng, t.heading||0, distM);
    t.lat = p.lat; t.lng = p.lng;
  }

  // mode after teleport
  const after = prompt("–†–µ–∂–∏–º –ø—ñ—Å–ª—è —Ç–µ–ª–µ–ø–æ—Ä—Ç—É: 'move' –∞–±–æ 'stop'", t.status==="stop"?"stop":"move");
  if(after) t.status = after==="stop" ? "stop" : "move";

  // update marker position
  const ls = layersById.get(String(t.id));
  if(ls) ls.marker.setLatLng([t.lat,t.lng]);
  refreshTarget(t); save(); renderList();
  map.setView([t.lat,t.lng], Math.max(map.getZoom(), 8));
}

function cloneTarget(t){
  const c = JSON.parse(JSON.stringify(t));
  c.id = uid();
  c.createdAt = Date.now();
  c.lat = t.lat + 0.02;
  c.lng = t.lng + 0.02;
  data.targets.push(c);
  addTargetLayers(c);
  save(); renderList();
}

function deleteTarget(t, noConfirm){
  if(!noConfirm){ if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –æ–±'—î–∫—Ç?")) return; }
  const idx = data.targets.findIndex(x => x.id === t.id);
  if(idx>=0) data.targets.splice(idx,1);
  const ls = layersById.get(String(t.id));
  if(ls){
    map.removeLayer(ls.marker);
    map.removeLayer(ls.label);
    map.removeLayer(ls.dirLine);
    map.removeLayer(ls.traj);
    map.removeLayer(ls.turnPoints);
    map.removeLayer(ls.threatSector);
    map.removeLayer(ls.idLabel);
    layersById.delete(t.id);
  }
  save(); renderList();
}

// --- Create target ---
function assignIdText(){
  let n;
  if(state.idMode==="seq"){
    n = state.seqNext++;
    if(n > Number(state.idTo||9999)) state.seqNext = Number(state.idFrom||1000);
  } else {
    const from = Number(state.idFrom||1000);
    const to = Number(state.idTo||9999);
    n = Math.floor(from + Math.random()*(to-from+1));
  }
  const suf = (state.idSuffix||"").trim();
  return suf ? `${n}${suf}` : `${n}`;
}

function createTargetAt(latlng, headingOverride){
  const t = {
    id: uid(),
    owner: state.filter==="mine" ? "mine" : "foreign",
    type: $("type").value,
    status: $("status").value,
    name: $("name").value,
    count: Number($("count").value||1),
    speed: Number($("speed").value||0),
    rangeKm: Number($("rangeKm").value||0),
    heading: (headingOverride!=null ? Number(headingOverride) : Number($("heading").value||0)),
    threatRadius: Number($("threatRadius").value||0),
    threatAngle: Number($("threatAngle").value||90),
    lat: latlng.lat,
    lng: latlng.lng,
    createdAt: Date.now(),
    paused: false,
    points: [],
    trajectory: [{ lat: latlng.lat, lng: latlng.lng, t: Date.now() }],
    _idText: assignIdText()
  };
  data.targets.push(t);
  addTargetLayers(t);
  save();
  renderList();
  // keep add mode enabled so user can create multiple targets with 2 clicks
  state.addStep=0;
  state.addFirstLatLng=null;
  if(state.addMode){
    $("btnAdd").classList.add("active");
    $("btnAdd").textContent = "üü¢ –ö–ª—ñ–∫ 1: –º—ñ—Å—Ü–µ —Ü—ñ–ª—ñ";
  } else {
    $("btnAdd").classList.remove("active");
    $("btnAdd").textContent = "‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ü—ñ–ª—å";
  }
}

// --- Trajectory update loop (approximation) ---
let tickHandle = null;
function setTick(){
  if(tickHandle) { clearInterval(tickHandle); tickHandle=null; }
  const rate = state.tickRate;
  if(rate==="smooth"){
    // 20 fps-ish; still uses interval
    tickHandle = setInterval(() => step(0.05), 50);
  } else {
    const sec = Number(rate||5);
    tickHandle = setInterval(() => step(sec), sec*1000);
  }
}
function step(dtSec){
  const now = Date.now();
  for(const t of data.targets){
    if(t.paused) continue;
    if(t.status==="stop") continue;
    if((t.speed||0)<=0) continue;

    // apply renderMode: skip every other tick in "50%" mode
    if(state.renderMode==="50" && Math.random()<0.5) continue;

    // movement
    const km = (t.speed||0) * (dtSec/3600) * timeMultiplier;
    const p = destinationPoint(t.lat,t.lng, t.heading||0, kmToMeters(km));

    t.lat = p.lat; t.lng = p.lng;

    // turning: if points exist, steer toward first point when close enough
    if((t.points||[]).length){
      const next = t.points[0];
      const dist = haversineKm(t.lat,t.lng,next.lat,next.lng);
      const br = bearing(t.lat,t.lng,next.lat,next.lng);
      t.heading = Math.round((br+360)%360);
      if(dist < 2){ // reached (2km)
        t.points.shift();
      }
    }

    t.trajectory = t.trajectory || [];
    t.trajectory.push({ lat:t.lat, lng:t.lng, t: now });
    // keep last 600 points
    if(t.trajectory.length>600) t.trajectory.splice(0, t.trajectory.length-600);

    const ls = layersById.get(String(t.id));
    if(ls) ls.marker.setLatLng([t.lat,t.lng]);
    refreshTarget(t);
  }
  save();
  renderList(false);
}
function haversineKm(lat1,lng1,lat2,lng2){
  const R = 6371;
  const dLat = deg2rad(lat2-lat1);
  const dLng = deg2rad(lng2-lng1);
  const a = Math.sin(dLat/2)**2 + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

// Speed tool (global multiplier like original ‚Äú–≥–ª–æ–±–∞–ª—å–Ω–∏–π –∫–æ–µ—Ñ. —á–∞—Å—É‚Äù)
let timeMultiplier = 1.0;

// --- List render ---
function renderList(scrollToTop=true){
  const list = $("list");
  const prevScroll = list.scrollTop;

  list.innerHTML = "";
  const filtered = data.targets
    .filter(t => state.onlyMine ? t.owner==="mine" : true)
    .filter(t => state.filter==="mine" ? t.owner==="mine" : t.owner==="foreign")
    .slice()
    .sort((a,b)=> b.createdAt - a.createdAt);

  if(!filtered.length){
    list.innerHTML = `<div class="hint">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î —Ü—ñ–ª–µ–π.</div>`;
    return;
  }

  for(const t of filtered){
    const title = (t.name?.trim()?t.name.trim():t.type);
    const dot = statusDot(t.status);
    const paused = t.paused ? " ‚Ä¢ –ø–∞—É–∑–∞" : "";
    const etaMin = estimateMinutes(t);

    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="itemTitle">${escapeHtml(title)}</div>
          <div class="hint">${escapeHtml(t.type)} ‚Ä¢ ${t.heading ?? 0}¬∞ ‚Ä¢ ${t.speed ?? 0} –∫–º/–≥–æ–¥ ‚Ä¢ ID: ${(t._idText||"--")}${paused}</div>
        </div>
        <span class="badge"><span class="dot ${dot}"></span>${statusText(t.status)} ‚Ä¢ ${etaMin}</span>
      </div>

      <div class="actions">
        <button class="btn small" data-act="show" data-id="${t.id}">–ü–æ–∫–∞–∑–∞—Ç–∏</button>
        <button class="btn small" data-act="apply" data-id="${t.id}">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∑ –ø–∞–Ω–µ–ª—ñ</button>
        <button class="btn small" data-act="dir" data-id="${t.id}">–ù–∞–ø—Ä—è–º–æ–∫</button>
        <button class="btn small danger" data-act="del" data-id="${t.id}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
      </div>
    `;
    list.appendChild(el);
  }

  list.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      const t = data.targets.find(x=>String(x.id)===String(id));
      if(!t) return;

      if(act==="show"){
        map.setView([t.lat,t.lng], Math.max(map.getZoom(), 10));
        const ls = layersById.get(String(t.id));
        ls?.marker.openPopup();
      }
      if(act==="apply"){
        // Apply target values to the panel (not –Ω–∞–æ–±–æ—Ä–æ—Ç)
        $("type").value = t.type || "–®–∞—Ö–µ–¥";
        $("status").value = t.status || "move";
        $("name").value = t.name || "";
        $("count").value = (t.count ?? 1);
        $("speed").value = (t.speed ?? 0);
        $("rangeKm").value = (t.rangeKm ?? 0);
        $("heading").value = (t.heading ?? 0);
        $("threatRadius").value = (t.threatRadius ?? 0);
        $("threatAngle").value = (t.threatAngle ?? 90);
      }
      if(act==="dir"){
        startSetDirection(t);
      }
      if(act==="del"){
        deleteTarget(t);
      }
    });
  });

  if(!scrollToTop) list.scrollTop = prevScroll;
}

function estimateMinutes(t){
  // just a display like "0 —Ö–≤."
  if(t.status==="stop" || (t.speed||0)<=0) return "0 —Ö–≤.";
  // if has next point, estimate time to it
  if((t.points||[]).length){
    const p = t.points[0];
    const dKm = haversineKm(t.lat,t.lng,p.lat,p.lng);
    const h = dKm / (t.speed||1);
    const m = Math.round(h*60);
    return `${m} —Ö–≤.`;
  }
  return "‚Äî";
}

// --- Export/Import ---
function save(){
  const payload = { state, data };
  localStorage.setItem(getAppLSKey(), JSON.stringify(payload));
}
function load(){
  try{
    const raw = localStorage.getItem(getAppLSKey());
    if(!raw) return;
    const payload = JSON.parse(raw);
    if(payload?.state) Object.assign(state, payload.state);
    if(payload?.data) data = payload.data;
  }catch(e){}
}
function exportJson(){
  const blob = new Blob([JSON.stringify({ state, data }, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ukraine_radar_local.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
async function importJson(file){
  const txt = await file.text();
  const obj = JSON.parse(txt);
  if(!obj?.data || !obj?.state) throw new Error("–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç");
  // clear existing layers
  for(const [id, ls] of layersById.entries()){
    map.removeLayer(ls.marker);
    map.removeLayer(ls.label);
    map.removeLayer(ls.dirLine);
    map.removeLayer(ls.traj);
    map.removeLayer(ls.turnPoints);
    map.removeLayer(ls.threatSector);
    map.removeLayer(ls.idLabel);
    layersById.delete(id);
  }
  Object.assign(state, obj.state);
  data = obj.data;
  // rebuild
  (data.targets||[]).forEach(t => addTargetLayers(t));
  applyStateToUI();
  save();
  renderList();
}

// --- Screenshot ---
async function takeScreenshot(){
  const canvas = await html2canvas($("mapWrap"), { useCORS:true, backgroundColor:null, scale: 1.5 });
  const url = canvas.toDataURL("image/png");
  $("shotImg").src = url;
  $("shotModal").style.display = "flex";
  $("btnSaveShot").onclick = () => {
    const a = document.createElement("a");
    a.href = url;
    a.download = "screenshot.png";
    a.click();
  };
}

// --- Forecast ---
function clearForecast(){
  if(forecastLayer){ map.removeLayer(forecastLayer); forecastLayer=null; }
}
function showForecast(){
  clearForecast();
  // forecast selected = nearest target to center
  if(!data.targets.length) return;
  const center = map.getCenter();
  let best = null, bestD=1e9;
  for(const t of data.targets){
    const d = haversineKm(center.lat, center.lng, t.lat, t.lng);
    if(d<bestD){ bestD=d; best=t; }
  }
  if(!best) return;

  const mins = Number(state.forecastMin||20);
  const speed = Number(best.speed||0);
  if(speed<=0) return;

  const pts = [];
  pts.push([best.lat,best.lng]);
  for(let m=1;m<=mins;m++){
    const km = speed * (m/60) * timeMultiplier;
    const p = destinationPoint(best.lat,best.lng, best.heading||0, kmToMeters(km));
    pts.push([p.lat,p.lng]);
  }
  forecastLayer = L.polyline(pts, { color:"#6fe3ff", weight:3, opacity:0.9, dashArray:"6 8" }).addTo(map);
  map.fitBounds(forecastLayer.getBounds(), { padding:[30,30] });
}

// --- Watermark ---
function drawWatermark(text, color, opacity, angleDeg, density, pos){
  const c = $("watermark");
  const ctx = c.getContext("2d");
  const wrap = $("mapWrap");
  c.width = wrap.clientWidth;
  c.height = wrap.clientHeight;

  ctx.clearRect(0,0,c.width,c.height);
  ctx.save();
  ctx.globalAlpha = opacity;

  const fontSize = 22;
  ctx.font = `700 ${fontSize}px system-ui, -apple-system, Segoe UI`;
  ctx.fillStyle = color;

  const stepX = 260 / density;
  const stepY = 160 / density;

  // position offset
  let ox = c.width/2, oy=c.height/2;
  if(pos==="tl"){ ox = 140; oy = 60; }
  if(pos==="tr"){ ox = c.width-140; oy = 60; }
  if(pos==="bl"){ ox = 140; oy = c.height-60; }
  if(pos==="br"){ ox = c.width-140; oy = c.height-60; }

  ctx.translate(ox,oy);
  ctx.rotate(deg2rad(angleDeg));
  ctx.translate(-ox,-oy);

  for(let y=-c.height; y<c.height*2; y+=stepY){
    for(let x=-c.width; x<c.width*2; x+=stepX){
      ctx.fillText(text, x, y);
    }
  }
  ctx.restore();
}

// --- Crosshair ---
function renderCrosshair(){
  const host = $("crosshair");
  host.innerHTML = "";
  if(!state.crosshairOn){ host.style.display="none"; return; }
  host.style.display="block";

  const size = Number(state.crosshairSize||60);
  const col = state.crosshairColor || "#fff";
  const op = Number(state.crosshairOpacity||0.7);
  const type = state.crosshairType || "1";

  let svg;
  if(type==="1"){
    svg = `<svg width="${size}" height="${size}" viewBox="0 0 100 100" style="opacity:${op}">
      <circle cx="50" cy="50" r="18" fill="none" stroke="${col}" stroke-width="3"/>
      <line x1="50" y1="2" x2="50" y2="28" stroke="${col}" stroke-width="3"/>
      <line x1="50" y1="72" x2="50" y2="98" stroke="${col}" stroke-width="3"/>
      <line x1="2" y1="50" x2="28" y2="50" stroke="${col}" stroke-width="3"/>
      <line x1="72" y1="50" x2="98" y2="50" stroke="${col}" stroke-width="3"/>
    </svg>`;
  } else if(type==="2"){
    svg = `<svg width="${size}" height="${size}" viewBox="0 0 100 100" style="opacity:${op}">
      <circle cx="50" cy="50" r="10" fill="${col}"/>
      <circle cx="50" cy="50" r="26" fill="none" stroke="${col}" stroke-width="2" stroke-dasharray="4 5"/>
      <line x1="50" y1="0" x2="50" y2="38" stroke="${col}" stroke-width="2"/>
      <line x1="50" y1="62" x2="50" y2="100" stroke="${col}" stroke-width="2"/>
    </svg>`;
  } else {
    svg = `<svg width="${size}" height="${size}" viewBox="0 0 100 100" style="opacity:${op}">
      <rect x="14" y="14" width="72" height="72" fill="none" stroke="${col}" stroke-width="2"/>
      <line x1="50" y1="14" x2="50" y2="86" stroke="${col}" stroke-width="2"/>
      <line x1="14" y1="50" x2="86" y2="50" stroke="${col}" stroke-width="2"/>
    </svg>`;
  }
  host.innerHTML = svg;
}

// --- UI wiring ---
function setTab(name){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
  $("tab-targets").style.display = (name==="targets") ? "block" : "none";
$("tab-settings").style.display = (name==="settings") ? "block" : "none";
  $("tab-tools").style.display = (name==="tools") ? "block" : "none";
}
document.querySelectorAll(".tab").forEach(t=> t.addEventListener("click", ()=>setTab(t.dataset.tab)));

$("btnAdd").addEventListener("click", ()=>{
  state.addMode = !state.addMode;
  state.addStep = 0;
  state.addFirstLatLng = null;
  $("btnAdd").classList.toggle("active", state.addMode);
  $("btnAdd").textContent = state.addMode ? "üü¢ –ö–ª—ñ–∫ 1: –º—ñ—Å—Ü–µ —Ü—ñ–ª—ñ" : "‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ü—ñ–ª—å";
  $("btnTopAdd")?.classList.toggle("active", state.addMode);

});

// Top "+" button toggles add mode
$("btnTopAdd")?.addEventListener("click", ()=>{
  // disable drawing if enabled
  if(state.drawMode){ setDrawMode(false); }
  $("btnAdd").click();
});

// Panel toggle (show/hide left)
$("btnTogglePanel")?.addEventListener("click", ()=>{
  document.body.classList.toggle("panelHidden");
});

// ===== Drawing tool (click-to-draw) =====
const drawColors = ["#ffd54a","#ff3bd4","#32d6ff","#49d17d","#ff4d4d","#ffffff"];
let drawGroup = L.layerGroup().addTo(map);
let drawArrows = L.layerGroup().addTo(map);
let currentLine = null;
let currentPts = [];
let currentArrow = null;

function setDrawColorByIndex(i){
  state.drawColorIndex = (i+drawColors.length)%drawColors.length;
  const col = drawColors[state.drawColorIndex];
  const sw = $("drawColor");
  if(sw){ sw.style.background = col; sw.style.boxShadow = "0 0 0 3px rgba(0,0,0,.08) inset"; }
  if(currentLine){ currentLine.setStyle({color: col}); }
}
setDrawColorByIndex(state.drawColorIndex);

function arrowIcon(angleDeg, color){
  // simple triangle arrow (SVG) rotated by angleDeg
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">
    <polygon points="12,2 22,22 12,18 2,22" fill="${color}" />
  </svg>`;
  return L.divIcon({
    className: "drawArrow",
    html: `<div style="width:26px;height:26px;transform:rotate(${angleDeg}deg);transform-origin:50% 50%;">${svg}</div>`,
    iconSize:[26,26],
    iconAnchor:[13,13],
  });
}

function updateArrow(){
  if(!currentLine || currentPts.length < 2) return;
  const a = currentPts[currentPts.length-2];
  const b = currentPts[currentPts.length-1];
  const br = bearing(a.lat,a.lng,b.lat,b.lng);
  const angle = (br+360)%360;
  const col = drawColors[state.drawColorIndex];
  if(currentArrow){ drawArrows.removeLayer(currentArrow); currentArrow=null; }
  currentArrow = L.marker(b, {icon: arrowIcon(angle, col), interactive:false});
  currentArrow.addTo(drawArrows);
}

function finishDrawing(){
  if(!currentLine){ return; }
  updateArrow();
  currentLine = null;
  currentPts = [];
  currentArrow = null;
  $("drawHud").style.display = "none";
}

function undoDrawPoint(){
  if(!currentLine || currentPts.length===0) return;
  currentPts.pop();
  currentLine.setLatLngs(currentPts);
  if(currentPts.length<2){
    if(currentArrow){ drawArrows.removeLayer(currentArrow); currentArrow=null; }
  } else {
    updateArrow();
  }
}

function clearAllDrawings(){
  drawGroup.clearLayers();
  drawArrows.clearLayers();
  currentLine = null;
  currentPts = [];
  currentArrow = null;
}

function setDrawMode(on){
  state.drawMode = !!on;
  $("btnTopDraw")?.classList.toggle("active", state.drawMode);
  // HUD
  if(state.drawMode){
    $("drawHud").style.display = "flex";
    setDrawColorByIndex(state.drawColorIndex);
    // disable add mode if it was on
    if(state.addMode){
      state.addMode=false; state.addStep=0; state.addFirstLatLng=null;
      $("btnAdd").classList.remove("active");
      $("btnAdd").textContent = "‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ü—ñ–ª—å";
      $("btnTopAdd")?.classList.remove("active");
    }
    map.doubleClickZoom.disable();
  } else {
    $("drawHud").style.display = "none";
    finishDrawing();
    map.doubleClickZoom.enable();
  }
}

$("btnTopDraw")?.addEventListener("click", ()=>{
  setDrawMode(!state.drawMode);
});

$("btnDrawFinish")?.addEventListener("click", ()=>{
  finishDrawing();
});

$("btnDrawUndo")?.addEventListener("click", ()=>{
  undoDrawPoint();
});

$("btnDrawClear")?.addEventListener("click", ()=>{
  clearAllDrawings();
});

$("drawColor")?.addEventListener("click", ()=>{
  setDrawColorByIndex(state.drawColorIndex+1);
});

// drawing click handler has priority
map.on("click", (e)=>{
  if(!state.drawMode) return;
  // add point
  currentPts.push(e.latlng);
  const col = drawColors[state.drawColorIndex];
  if(!currentLine){
    currentLine = L.polyline(currentPts, {color: col, weight: 4, opacity: 0.95});
    currentLine.addTo(drawGroup);
  } else {
    currentLine.setLatLngs(currentPts);
  }
  updateArrow();
});

map.on("dblclick", (e)=>{
  if(!state.drawMode) return;
  // finish current line on double click
  finishDrawing();
});

// right click = undo last point (fast)
map.on("contextmenu", (e)=>{
  if(!state.drawMode) return;
  undoDrawPoint();
});
$("btnCenter").addEventListener("click", ()=> map.setView([48.3794, 31.1656], 6));
$("btnClear").addEventListener("click", ()=> { if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ —Ü—ñ–ª—ñ?")) { data.targets=[]; save(); location.reload(); } });
$("btnClear2").addEventListener("click", ()=> { if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ —Ü—ñ–ª—ñ?")) { data.targets=[]; save(); location.reload(); } });
$("btnReload").addEventListener("click", ()=> location.reload());

$("filterMine").addEventListener("click", ()=>{
  state.filter="mine";
  $("filterMine").classList.add("active");
  $("filterForeign").classList.remove("active");
  renderList();
});
$("filterForeign").addEventListener("click", ()=>{
  state.filter="foreign";
  $("filterForeign").classList.add("active");
  $("filterMine").classList.remove("active");
  renderList();
});

$("btnExport").addEventListener("click", exportJson);
$("btnImport").addEventListener("click", ()=> $("file").click());
$("file").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  try{ await importJson(f); } catch(err){ alert("–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: " + err.message); }
  e.target.value="";
});

$("btnShot").addEventListener("click", takeScreenshot);
$("btnCloseShot").addEventListener("click", ()=> $("shotModal").style.display="none");
$("shotModal").addEventListener("click", (e)=> { if(e.target.id==="shotModal") $("shotModal").style.display="none"; });

$("btnForecastShow").addEventListener("click", showForecast);
$("btnForecastClear").addEventListener("click", clearForecast);

// switches helper
function bindSwitch(id, key, onChange){
  const el = $(id);
  const set = (v)=>{
    state[key] = v;
    el.classList.toggle("on", !!v);
    onChange?.(v);
    save();
  };
  el.addEventListener("click", ()=> set(!state[key]));
  el.classList.toggle("on", !!state[key]);
}
bindSwitch("swStatusIcons","showStatusIcons", ()=>{ /* only affects list badges; kept */ });
bindSwitch("swHideThreats","hideThreats", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swFrontLine","showFrontLine", ()=> applyFrontOccupied());
bindSwitch("swOccupied","showOccupied", ()=> applyFrontOccupied());
applyFrontOccupied();
bindSwitch("swAnnounce","showAnnounce", (v)=> updateAnnounce());
bindSwitch("swTurnPoints","showTurnPoints", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swGlow","glow", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swDynSize","dynSize", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swLabelBg","labelBgOn", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swLabels","labelsOn", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swCrosshair","crosshairOn", ()=> renderCrosshair());
bindSwitch("swShowId","showId", ()=> data.targets.forEach(refreshTarget));

bindSwitch("swBorder","borderOn", async (v)=>{
  await ensureBorder();
  if(v) borderLayer.addTo(map); else map.removeLayer(borderLayer);
  rebuildMask();
});
bindSwitch("swOblast","oblastOn", async (v)=>{
  await ensureOblast();
  if(v){
    oblastLayer.addTo(map);
    hookOblastClicks();
    applyOblastStyles();
  } else {
    map.removeLayer(oblastLayer);
  }
});
bindSwitch("swRaion","raionOn", async (v)=>{
  await ensureRaion();
  if(v) raionLayer.addTo(map); else map.removeLayer(raionLayer);
});

// contour color pickers
["borderStroke","oblastStroke","raionStroke"].forEach((id)=>{
  const el = $(id);
  if(!el) return;
  el.addEventListener("input", ()=>{
    state[id] = el.value;
    if(id==="borderStroke" && borderLayer) borderLayer.setStyle(styleBorder);
    if(id==="oblastStroke" && oblastLayer) oblastLayer.setStyle(styleRegion);
    if(id==="raionStroke" && raionLayer) raionLayer.setStyle(styleRaion);
    save();
  });
});
bindSwitch("swMask","maskOn", async (v)=>{
  await ensureBorder();
  rebuildMask();
});

bindSwitch("swTraj","trajOn", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swDirLine","dirLineOn", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swFps","fpsOn", (v)=> $("fps").style.display = v ? "block" : "none");

bindSwitch("swOnlyMine","onlyMine", (v)=>{ state.onlyMine=v; renderList(); });

bindSwitch("swAlarms","alarmsOn", ()=> refreshAlarms());
bindSwitch("swFront","frontOn", ()=> refreshFront());

$("announceText").addEventListener("input", (e)=>{ state.announceText = e.target.value; updateAnnounce(); save(); });

function updateAnnounce(){
  const a = $("announce");
  if(state.showAnnounce && (state.announceText||"").trim()){
    a.textContent = state.announceText.trim();
    a.style.display = "block";
  } else {
    a.style.display = "none";
  }
}

$("iconColor").addEventListener("input",(e)=>{ state.iconColor=e.target.value; data.targets.forEach(refreshTarget); save(); });
$("iconSize").addEventListener("input",(e)=>{ state.iconSize=Number(e.target.value||30); data.targets.forEach(refreshTarget); save(); });
$("labelColor").addEventListener("input",(e)=>{ state.labelColor=e.target.value; data.targets.forEach(refreshTarget); save(); });
$("labelBg").addEventListener("input",(e)=>{ state.labelBg=e.target.value; data.targets.forEach(refreshTarget); save(); });
$("labelSize").addEventListener("input",(e)=>{ state.labelSize=Number(e.target.value||12); data.targets.forEach(refreshTarget); save(); });

$("crosshairType").addEventListener("change",(e)=>{ state.crosshairType=e.target.value; renderCrosshair(); save(); });
$("crosshairColor").addEventListener("input",(e)=>{ state.crosshairColor=e.target.value; renderCrosshair(); save(); });
$("crosshairSize").addEventListener("input",(e)=>{ state.crosshairSize=Number(e.target.value||60); renderCrosshair(); save(); });
$("crosshairOpacity").addEventListener("input",(e)=>{ state.crosshairOpacity=Number(e.target.value||0.7); renderCrosshair(); save(); });

$("idMode").addEventListener("change",(e)=>{ state.idMode=e.target.value; save(); });
$("idFrom").addEventListener("input",(e)=>{ state.idFrom=Number(e.target.value||1000); save(); });
$("idTo").addEventListener("input",(e)=>{ state.idTo=Number(e.target.value||9999); save(); });
$("idSuffix").addEventListener("input",(e)=>{ state.idSuffix=e.target.value; save(); });
$("idColor").addEventListener("input",(e)=>{ state.idColor=e.target.value; data.targets.forEach(refreshTarget); save(); });
$("idSize").addEventListener("input",(e)=>{ state.idSize=Number(e.target.value||12); data.targets.forEach(refreshTarget); save(); });

$("baseLayer").addEventListener("change",(e)=>{ state.baseLayer=e.target.value; setBaseLayer(); save(); });
function setBaseLayer(){
  Object.values(baseLayers).forEach(l=> map.removeLayer(l));
  baseLayers[state.baseLayer]?.addTo(map);
}

$("trajStyle").addEventListener("change",(e)=>{ state.trajStyle=e.target.value; data.targets.forEach(refreshTarget); save(); });
$("trajColor").addEventListener("input",(e)=>{ state.trajColor=e.target.value; data.targets.forEach(refreshTarget); save(); });
$("trajWidth").addEventListener("input",(e)=>{ state.trajWidth=Number(e.target.value||3); data.targets.forEach(refreshTarget); save(); });
$("trajOpacity").addEventListener("input",(e)=>{ state.trajOpacity=Number(e.target.value||0.9); data.targets.forEach(refreshTarget); save(); });
$("forecastMin").addEventListener("input",(e)=>{ state.forecastMin=Number(e.target.value||20); save(); });

$("tickRate").addEventListener("change",(e)=>{ state.tickRate=e.target.value; setTick(); save(); });
$("renderMode").addEventListener("change",(e)=>{ state.renderMode=e.target.value; save(); });

$("btnSpeed").addEventListener("click", ()=>{
  const v = Number(prompt("–ì–ª–æ–±–∞–ª—å–Ω–∏–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —á–∞—Å—É (0.5 - 2.0):", timeMultiplier.toFixed(2))||timeMultiplier);
  timeMultiplier = clamp(v, 0.5, 2.0);
  alert("–ì–æ—Ç–æ–≤–æ: √ó" + timeMultiplier.toFixed(2));
});

$("btnWatermark").addEventListener("click", ()=>{
  const text = prompt("–¢–µ–∫—Å—Ç –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:", "–¢–ï–ö–°–¢");
  if(!text){ $("watermark").style.display="none"; return; }
  const density = Number(prompt("–©—ñ–ª—å–Ω—ñ—Å—Ç—å (1..5):", "2")||"2");
  const col = prompt("–ö–æ–ª—ñ—Ä (hex, –Ω–∞–ø—Ä #ffffff):", "#ffffff") || "#ffffff";
  const op = Number(prompt("–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å (0..1):", "0.20")||"0.2");
  const angle = Number(prompt("–ö—É—Ç (¬∞):", "30")||"30");
  const pos = prompt("–ü–æ–∑–∏—Ü—ñ—è: center/tl/tr/bl/br", "center") || "center";
  drawWatermark(text, col, clamp(op,0,1), angle, clamp(density,1,5), pos);
  $("watermark").style.display="block";
});

$("btnStatic").addEventListener("click", ()=>{
  alert("–°—Ç–∞—Ç–∏—á–Ω—ñ –æ–±'—î–∫—Ç–∏ –Ω–∞ –æ—Ä–∏–≥—ñ–Ω–∞–ª—ñ: –ü–£ –®–∞—Ö–µ–¥—ñ–≤/–∞–µ—Ä–æ–¥—Ä–æ–º–∏/–º–æ—Ä—Å—å–∫—ñ –±–∞–∑–∏/–ü–£ –ë–∞–ª—ñ—Å—Ç–∏–∫–∏. –¢—É—Ç —ó—Ö –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ —è–∫ GeoJSON —á–µ—Ä–µ–∑ —ñ–º–ø–æ—Ä—Ç (—É –≤–∫–ª–∞–¥—Ü—ñ –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏: —Ñ—Ä–æ–Ω—Ç/—Ç—Ä–∏–≤–æ–≥–∏).");
});

// alarms/front (import)
$("alarmService").addEventListener("change",(e)=>{ state.alarmService=e.target.value; save(); });
$("uaKey").addEventListener("input",(e)=>{ state.uaKey=e.target.value; save(); });
$("alarmOpacity").addEventListener("input",(e)=>{ state.alarmOpacity=Number(e.target.value||0.10); refreshAlarms(); save(); });

$("btnAlarmImport").addEventListener("click", ()=> $("alarmFile").click());
$("alarmFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  try{ data.alarmsGeojson = JSON.parse(await f.text()); refreshAlarms(); save(); }
  catch(err){ alert("–ü–æ–º–∏–ª–∫–∞ GeoJSON: " + err.message); }
  e.target.value="";
});
$("btnAlarmClear").addEventListener("click", ()=>{ data.alarmsGeojson=null; refreshAlarms(); save(); });

$("btnFrontImport").addEventListener("click", ()=> $("frontFile").click());
$("frontFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  try{ data.frontGeojson = JSON.parse(await f.text()); refreshFront(); save(); }
  catch(err){ alert("–ü–æ–º–∏–ª–∫–∞ GeoJSON: " + err.message); }
  e.target.value="";
});
$("btnFrontClear").addEventListener("click", ()=>{ data.frontGeojson=null; refreshFront(); save(); });

$("frontLineColor").addEventListener("input",(e)=>{ state.frontLineColor=e.target.value; refreshFront(); save(); });
$("frontFillColor").addEventListener("input",(e)=>{ state.frontFillColor=e.target.value; refreshFront(); save(); });

// overlays layers
let alarmsLayer = null;
function refreshAlarms(){
  if(alarmsLayer){ map.removeLayer(alarmsLayer); alarmsLayer=null; }
  if(!state.alarmsOn) return;

  if(state.alarmService==="custom" && data.alarmsGeojson){
    alarmsLayer = L.geoJSON(data.alarmsGeojson, {
      style:{ color:"#ff4d4d", weight:1, fillColor:"#ff4d4d", fillOpacity: clamp(state.alarmOpacity,0,1) }
    }).addTo(map);
    return;
  }

  if(state.alarmService==="ukrainealarm"){
    // Official API requires a key (not shipped here). We'll attempt fetch if key provided.
    if(!(state.uaKey||"").trim()){
      alert("–ü–æ—Ç—Ä—ñ–±–µ–Ω UkraineAlarm API key.");
      return;
    }
    // Endpoint list exists in various libs/docs; actual access may be restricted by CORS.
    // We'll do a best-effort request and if it fails, tell user.
    fetch("https://api.ukrainealarm.com/api/v3/alerts", {
      headers: { "Authorization": state.uaKey.trim() }
    }).then(r=>r.json()).then(json=>{
      // This API returns alerts list, not polygons. User still needs polygons mapping.
      alert("–û—Ç—Ä–∏–º–∞–Ω–æ –¥–∞–Ω—ñ, –∞–ª–µ –¥–ª—è –≤—ñ–¥–º–∞–ª—é–≤–∞–Ω–Ω—è –ø–æ—Ç—Ä—ñ–±–Ω—ñ –ø–æ–ª—ñ–≥–æ–Ω–∏ —Ä–∞–π–æ–Ω—ñ–≤/–æ–±–ª–∞—Å—Ç–µ–π, –∑–≤'—è–∑–∞–Ω—ñ –∑ regionId. –¶–µ –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏, —è–∫—â–æ —Ç–∏ –¥–∞—Å–∏ —Ç–∞–±–ª–∏—Ü—é –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ ID‚Üî–ø–æ–ª—ñ–≥–æ–Ω.");
    }).catch(()=>{
      alert("–ù–µ –≤–∏–π—à–ª–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ UkraineAlarm (–º–æ–∂–µ –±–ª–æ–∫—É–≤–∞—Ç–∏—Å—è CORS —É –±—Ä–∞—É–∑–µ—Ä—ñ). –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π '–°–≤—ñ–π GeoJSON (—ñ–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–æ–º)'.");
    });
  }
}

let frontLayer = null;
function refreshFront(){
  if(frontLayer){ map.removeLayer(frontLayer); frontLayer=null; }
  if(!state.frontOn) return;
  if(!data.frontGeojson) return;
  frontLayer = L.geoJSON(data.frontGeojson, {
    style:{
      color: state.frontLineColor,
      weight: 2,
      fillColor: state.frontFillColor,
      fillOpacity: 0.12
    }
  }).addTo(map);
}

// oblast select
function populateOblastSelect(gj){
  const sel = $("oblastSelect");
  sel.innerHTML="";
  const names = new Set();
  for(const f of (gj.features||[])){
    const name = (f.properties?.name || f.properties?.region || f.properties?.NAME_1 || "").toString();
    if(name) names.add(name);
  }
  [...names].sort((a,b)=>a.localeCompare(b,"uk")).forEach(n=>{
    const o = document.createElement("option");
    o.value=n; o.textContent=n;
    sel.appendChild(o);
  });
  // apply current
  for(const opt of sel.options){
    opt.selected = state.highlightedOblasts.includes(opt.value);
  }
  sel.addEventListener("change", ()=>{
    state.highlightedOblasts = [...sel.selectedOptions].map(o=>o.value);
    if(oblastLayer) oblastLayer.setStyle(styleRegion);
    save();
  });
}
$("btnOblastReset").addEventListener("click", ()=>{
  state.highlightedOblasts = [];
  for(const opt of $("oblastSelect").options) opt.selected=false;
  if(oblastLayer) oblastLayer.setStyle(styleRegion);
  save();
});

// apply state to UI elements
function applyStateToUI(){
  $("announceText").value = state.announceText || "";
  $("iconColor").value = state.iconColor;
  $("iconSize").value = state.iconSize;
  $("labelColor").value = state.labelColor;
  $("labelBg").value = state.labelBg;
  $("labelSize").value = state.labelSize;

  $("crosshairType").value = state.crosshairType;
  $("crosshairColor").value = state.crosshairColor;
  $("crosshairSize").value = state.crosshairSize;
  $("crosshairOpacity").value = state.crosshairOpacity;

  $("idMode").value = state.idMode;
  $("idFrom").value = state.idFrom;
  $("idTo").value = state.idTo;
  $("idSuffix").value = state.idSuffix;
  $("idColor").value = state.idColor;
  $("idSize").value = state.idSize;

  $("baseLayer").value = state.baseLayer;
  $("trajStyle").value = state.trajStyle;
  if($("borderStroke")) $("borderStroke").value = state.borderStroke || "#ffffff";
  if($("oblastStroke")) $("oblastStroke").value = state.oblastStroke || "#ffffff";
  if($("raionStroke")) $("raionStroke").value = state.raionStroke || "#ffffff";
  $("trajColor").value = state.trajColor;
  $("trajWidth").value = state.trajWidth;
  $("trajOpacity").value = state.trajOpacity;
  $("forecastMin").value = state.forecastMin;

  $("tickRate").value = state.tickRate;
  $("renderMode").value = state.renderMode;

  $("alarmService").value = state.alarmService;
  $("uaKey").value = state.uaKey;
  $("alarmOpacity").value = state.alarmOpacity;

  $("frontLineColor").value = state.frontLineColor;
  $("frontFillColor").value = state.frontFillColor;

  // buttons
  $("filterMine").classList.toggle("active", state.filter==="mine");
  $("filterForeign").classList.toggle("active", state.filter==="foreign");
  updateAnnounce();
  renderCrosshair();
  setBaseLayer();
  $("fps").style.display = state.fpsOn ? "block" : "none";
}

// FPS counter
let fpsLast = performance.now(), fpsFrames=0;
function fpsLoop(){
  fpsFrames++;
  const now = performance.now();
  if(now - fpsLast >= 1000){
    const fps = Math.round((fpsFrames*1000)/(now-fpsLast));
    fpsLast = now; fpsFrames=0;
    if(state.fpsOn) $("fps").textContent = "FPS: " + fps;
  }
  requestAnimationFrame(fpsLoop);
}
requestAnimationFrame(fpsLoop);

// icon resize on zoom if dyn size
map.on("zoomend", ()=>{
  if(!state.dynSize) return;
  data.targets.forEach(refreshTarget);
});

// init load
load();
applyStateToUI();

(async ()=>{
  // border default
  if(state.borderOn){
    try{ await ensureBorder(); }catch(e){}
  }
  if(state.oblastOn){
    try{ await ensureOblast(); oblastLayer.addTo(map);
      hookOblastClicks();
      applyOblastStyles();
 }catch(e){}
  }
  if(state.raionOn){
    try{ await ensureRaion(); raionLayer.addTo(map); }catch(e){}
  }
  rebuildMask();
})();

// rebuild targets layers
(data.targets||[]).forEach(t => addTargetLayers(t));
renderList();
setTick();

// announce
updateAnnounce();

// === City search (Nominatim) ===
(function(){
  const inp = $("citySearch"), box = $("cityResults");
  if(!inp || !box) return;
  let tmr=null, lastQ="";
  const show = (items)=>{
    box.innerHTML = items.map(it=>`
      <div class="item" data-lat="${it.lat}" data-lon="${it.lon}">
        <b>${escapeHtml(it.name)}</b>
        <span class="small">${escapeHtml(it.desc||"")}</span>
      </div>`).join("");
    box.style.display = items.length ? "block" : "none";
  };
  inp.addEventListener("input", ()=>{
    const q = inp.value.trim();
    if(q===lastQ) return;
    lastQ=q;
    if(tmr) clearTimeout(tmr);
    if(!q){ box.style.display="none"; return; }
    tmr=setTimeout(async ()=>{
      try{
        const url = "https://nominatim.openstreetmap.org/search?format=json&limit=8&addressdetails=1&q="+encodeURIComponent(q+" –£–∫—Ä–∞—ó–Ω–∞");
        const r = await fetch(url, { headers: { "Accept-Language":"uk" } });
        const j = await r.json();
        const items = (j||[]).map(x=>({
          lat: x.lat, lon: x.lon,
          name: (x.display_name||"").split(",")[0],
          desc: x.display_name || ""
        }));
        show(items);
      }catch(e){
        show([{lat:"",lon:"",name:"–ù–µ–º–∞—î —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É / –ø–æ—à—É–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π",desc:""}]);
      }
    }, 350);
  });
  box.addEventListener("click", (e)=>{
    const el = e.target.closest(".item");
    if(!el) return;
    const lat = parseFloat(el.dataset.lat), lon = parseFloat(el.dataset.lon);
    if(!isFinite(lat)||!isFinite(lon)) return;
    map.setView([lat,lon], 11);
    box.style.display="none";
  });
})();

// === Oblast selection: dim unselected ===
function normOblastName(s){
  return String(s||"")
    .toLowerCase()
    .replace(/[‚Äô'`]/g,"")
    .replace(/\b(–æ–±–ª–∞—Å—Ç—å|–æ–±–ª\.?|–º—ñ—Å—Ç–æ|–º\.)\b/g,"")
    .replace(/\s+/g," ")
    .trim();
}

function applyOblastStyles(){
  if(!oblastLayer) return;
  const sel = new Set((state.selOblasts||[]).map(normOblastName));
  oblastLayer.eachLayer(l=>{
    const nm = (l.feature?.properties?.name || l.feature?.properties?.NAME_1 || l.feature?.properties?.NAME || "").toString();
    const key = normOblastName(nm);

    const hasSelection = sel.size>0;
    const isSelected = !hasSelection || sel.has(key);

    l.setStyle({
      color: state.oblastStroke || "#00aaff",
      weight: isSelected ? 2.2 : 1.2,
      fillColor: "#000000",
      fillOpacity: hasSelection ? (isSelected ? 0.35 : 0.70) : 0.35,
      opacity: 0.95
    });
  });
}

let _suppressOblastSelectChange = false;

function syncOblastSelectFromSet(){
  const el = $("oblastSelect"); if(!el) return;
  _suppressOblastSelectChange = true;
  const want = new Set((state.selOblasts||[]).map(normOblastName).map(s=>s.toLowerCase()));
  for(const opt of el.options){
    opt.selected = want.has(opt.value.toLowerCase());
  }
  // allow "none selected" in multiple select
  if(el.multiple && want.size===0) el.selectedIndex = -1;
  _suppressOblastSelectChange = false;
}

$("oblastSelect")?.addEventListener("change", ()=>{
  if(_suppressOblastSelectChange) return;
  const el = $("oblastSelect");
  state.selOblasts = [...el.selectedOptions].map(o=>o.value);
  save();
  applyOblastStyles();
});
$("btnOblastReset")?.addEventListener("click", ()=>{
  state.selOblasts = [];
  save();
  syncOblastSelectFromSet();
  applyOblastStyles();
});

// Hook oblast clicks to toggle selection (when layer loaded)
function hookOblastClicks(){
  if(!oblastLayer) return;
  oblastLayer.eachLayer(l=>{
    l.off("click");
    l.on("click", ()=>{
      const nm = (l.feature?.properties?.name || l.feature?.properties?.NAME_1 || l.feature?.properties?.NAME || "").toString();
      if(!nm) return;
      const cur = new Set((state.selOblasts||[]));
      if(cur.has(nm)) cur.delete(nm); else cur.add(nm);
      state.selOblasts = [...cur];
      save();
      syncOblastSelectFromSet();
      applyOblastStyles();
    });
  });
}

// === Points (avatar-style markers) ===
state.points = state.points || [];
let pointMode=false;
function pointIconHTML(p){
  const label = escapeHtml(p.name||"");
  const kind = p.iconKind || "M";
  let inner = "";
  if(kind==="img" && p.img){
    inner = `<img src="${escapeHtml(p.img)}" alt="">`;
  }else if(kind==="pin"){
    inner = `<div style="font-size:18px;">üìç</div>`;
  }else{
    const ch = (label.trim()[0] || "‚Ä¢").toUpperCase();
    inner = `<div style="font-weight:900;">${escapeHtml(ch)}</div>`;
  }
  return `<div style="display:flex;flex-direction:column;align-items:center;">
    <div class="avatarMarker">${inner}</div>
    <div class="avatarLabel">${label}</div>
  </div>`;
}
function renderPoints(){
  if(!window.pointsLayer){
    window.pointsLayer = L.layerGroup().addTo(map);
  }
  window.pointsLayer.clearLayers();
  for(const p of (state.points||[])){
    const icon = L.divIcon({ className:"", html: pointIconHTML(p), iconSize:[60,60], iconAnchor:[30,30] });
    const m = L.marker([p.lat,p.lng], { icon }).addTo(window.pointsLayer);
    m.on("contextmenu", ()=>{
      if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ—á–∫—É '"+(p.name||"")+"'?")){
        state.points = (state.points||[]).filter(x=>x.id!==p.id);
        save();
        renderPoints();
      }
    });
  }
}
$("ptMode")?.addEventListener("click", ()=>{
  pointMode = !pointMode;
  $("ptMode").textContent = "üìç –†–µ–∂–∏–º –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ—á–∫–∏: " + (pointMode?"–£–≤—ñ–º–∫":"–í–∏–º–∫");
});
$("ptClear")?.addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ç–æ—á–∫–∏?")){
    state.points = [];
    save();
    renderPoints();
  }
});
document.querySelectorAll("[data-pt-example]")?.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    $("ptName").value = btn.getAttribute("data-pt-example") || "";
  });
});
map.on("click", (e)=>{
  if(!pointMode) return;
  const name = ($("ptName")?.value || "").trim() || "–¢–æ—á–∫–∞";
  const iconKind = ($("ptIcon")?.value || "M");
  const img = ($("ptImg")?.value || "").trim();
  const p = { id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()), name, iconKind, img, lat:e.latlng.lat, lng:e.latlng.lng };
  state.points.push(p);
  save();
  renderPoints();
});
renderPoints();


// === Oblast toggles list (alphabet UA) ===
const OBLASTS_UA = [
  "–ê–≤—Ç–æ–Ω–æ–º–Ω–∞ –†–µ—Å–ø—É–±–ª—ñ–∫–∞ –ö—Ä–∏–º",
  "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–í–æ–ª–∏–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–õ—É–≥–∞–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–û–¥–µ—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–°—É–º—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å"
];
function normOblastName(n){
  n = (n||"").toString().trim();
  // unify common variants from geojson
  n = n.replace(/^–º\.\s*/i,"").replace(/\s+–æ–±–ª\.?$/i," –æ–±–ª–∞—Å—Ç—å");
  if(n.toLowerCase()==="–∫—Ä–∏–º" || n.toLowerCase().includes("–∫—Ä–∏–º")) return "–ê–≤—Ç–æ–Ω–æ–º–Ω–∞ –†–µ—Å–ø—É–±–ª—ñ–∫–∞ –ö—Ä–∏–º";
  if(!/–æ–±–ª–∞—Å—Ç—å$/i.test(n) && !n.toLowerCase().includes("—Ä–µ—Å–ø—É–±–ª—ñ–∫–∞")) n += " –æ–±–ª–∞—Å—Ç—å";
  return n;
}
function renderOblastToggleList(){
  const box = $("oblastToggleList");
  if(!box) return;
  const sel = new Set((state.selOblasts||[]).map(normOblastName));
  box.innerHTML = OBLASTS_UA.map(name=>{
    const on = sel.size===0 ? false : sel.has(name);
    return `
      <div class="row" style="justify-content:space-between;gap:10px;">
        <div style="font-weight:700;">${escapeHtml(name)}</div>
        <div class="switch ${on?'on':''}" data-oblast="${escapeHtml(name)}"></div>
      </div>`;
  }).join("");
  box.querySelectorAll(".switch[data-oblast]").forEach(sw=>{
    sw.addEventListener("click", ()=>{
      const name = sw.getAttribute("data-oblast");
      const cur = new Set((state.selOblasts||[]).map(normOblastName));
      // if empty selection means "none selected" in UI; we will start selection set on first toggle
      if(cur.size===0){
        cur.add(name);
      } else {
        if(cur.has(name)) cur.delete(name); else cur.add(name);
      }
      state.selOblasts = [...cur];
      save();
      renderOblastToggleList();
      syncOblastSelectFromSet?.();
      applyOblastStyles?.();
    });
  });
}
$("oblastAll")?.addEventListener("click", ()=>{
  state.selOblasts = [...OBLASTS_UA];
  save(); renderOblastToggleList(); syncOblastSelectFromSet?.(); applyOblastStyles?.();
});
$("oblastNone")?.addEventListener("click", ()=>{
  // clear selection fully (toggles + multi-select) and prevent "change" from re-adding something like Kyiv
  state.selOblasts = [];
  const el = $("oblastSelect");
  if(el){
    _suppressOblastSelectChange = true;
    for(const opt of el.options) opt.selected = false;
    if(el.multiple) el.selectedIndex = -1;
    _suppressOblastSelectChange = false;
  }
  save();
  renderOblastToggleList();
  syncOblastSelectFromSet?.();
  applyOblastStyles?.();
});
// re-render when settings tab opened
document.querySelectorAll("[data-tab]")?.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    if(btn.getAttribute("data-tab")==="settings"){
      setTimeout(()=>renderOblastToggleList(), 50);
    }
  });
});


</script>

  <!-- AUTH OVERLAY -->


<script>
(function(){
  const LS_KEY = "UA_ADMIN_PANEL_DB_V1"; // —Ç–∞–∫–∏–π —Å–∞–º–∏–π –∫–ª—é—á —è–∫ –≤ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ
  const SESSION_KEY = "UA_MAP_SESSION_V1"; // –∞–∫—Ç–∏–≤–Ω–∞ —Å–µ—Å—ñ—è –≤—Ö–æ–¥—É (email+–∫–æ–¥)

  const overlay = document.getElementById("authOverlay");
  const banOverlay = document.getElementById("banOverlay");
  const banReasonText = document.getElementById("banReasonText");
  const banLogoutBtn = document.getElementById("banLogoutBtn");

  const emailEl = document.getElementById("authEmail");
  const keyEl = document.getElementById("authKey");
  const loginBtn = document.getElementById("authLoginBtn");
  const reloadBtn = document.getElementById("authReloadBtn");
  const msgEl = document.getElementById("authMsg");
  const mini = document.getElementById("authStatusMini");

  function setMsg(t, ok){
    msgEl.textContent = t || "";
    msgEl.style.color = ok ? "#22c55e" : "#ef4444";
  }

  function loadDB(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return {users:[]};
      const parsed = JSON.parse(raw);
      if(!parsed || !Array.isArray(parsed.users)) return {users:[]};
      return parsed;
    }catch(e){
      return {users:[]};
    }
  }

  function normEmail(s){
    return (s||"").trim();
  }

  function findUserByEmail(db, email){
    const low = String(email||"").trim().toLowerCase();
    return db.users.find(u => String(u.nick||"").trim().toLowerCase() === low) || null;
  }

  function saveSession(email, key){
    try{ localStorage.setItem(SESSION_KEY, JSON.stringify({email, key})); }catch(e){}
  }
  function clearSession(){
    try{ localStorage.removeItem(SESSION_KEY); }catch(e){}
  }
  function getSession(){
    try{
      const raw = localStorage.getItem(SESSION_KEY);
      if(!raw) return null;
      const s = JSON.parse(raw);
      if(!s || !s.email || !s.key) return null;
      return { email: String(s.email), key: String(s.key) };
    }catch(e){ return null; }
  }

  function showBan(reason){
    banReasonText.textContent = reason || "–ü—Ä–∏—á–∏–Ω—É –Ω–µ –≤–∫–∞–∑–∞–Ω–æ.";
    banOverlay.style.display = "flex";
    overlay.style.display = "none";
    mini.textContent = "–∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ";
  }

  function lock(){
    overlay.style.display = "flex";
    banOverlay.style.display = "none";
    mini.textContent = "–Ω–µ —É–≤—ñ–π—à–æ–≤";
  }
  function unlock(label){
    overlay.style.display = "none";
    banOverlay.style.display = "none";
    mini.textContent = label;
  }

  function applyUserState(u, key){
    // UID = email|key, —â–æ–± —É –∫–æ–∂–Ω–æ–≥–æ –∞–∫–∞—É–Ω—Ç–∞ –±—É–ª–æ —Å–≤–æ—î –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
    window.__MAP_USER__ = { nick: u.nick, role: u.role, uid: `${String(u.nick).trim()}|${String(key).trim()}` };
    try{
      if(typeof window.load === "function") window.load();
      if(typeof window.applyStateToUI === "function") window.applyStateToUI();
      if(typeof window.applyOblastStyles === "function") window.applyOblastStyles();
      if(typeof window.renderList === "function") window.renderList();
      if(typeof window.renderPoints === "function") window.renderPoints();
    }catch(e){}
  }

  async function doLogin(){
    const email = normEmail(emailEl.value);
    const key = (keyEl.value||"").trim();

    if(!email){ setMsg("–í–∫–∞–∂–∏ –ø–æ—à—Ç—É.", false); return; }
    if(!key){ setMsg("–í–∫–∞–∂–∏ –∫–æ–¥.", false); return; }

    const db = loadDB();
    const u = findUserByEmail(db, email);

    if(!u){
      setMsg("–ù–µ–º–∞—î —Ç–∞–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –±–∞–∑—ñ. –î–æ–¥–∞–π –ø–æ—à—Ç—É –≤ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ.", false);
      return;
    }

    // –±–∞–Ω
    if(u.banned){
      // –ø—Ä–∏—á–∏–Ω–∞ –º–æ–∂–µ –±—É—Ç–∏ —É —Ä—ñ–∑–Ω–∏—Ö –ø–æ–ª—è—Ö (–Ω–∞ –≤—Å—è–∫–∏–π)
      const reason = u.banReason || u.reason || u.bannedReason || "–ü—Ä–∏—á–∏–Ω—É –Ω–µ –≤–∫–∞–∑–∞–Ω–æ.";
      saveSession(email, key); // —â–æ–± –∞–¥–º—ñ–Ω –º—ñ–≥ —à–≤–∏–¥–∫–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ (–∞–ª–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—Å–µ –æ–¥–Ω–æ –Ω–µ —É–≤—ñ–π–¥–µ)
      showBan(reason);
      return;
    }

    if(!u.lastKey){
      setMsg("–î–ª—è —Ü—ñ—î—ó –ø–æ—à—Ç–∏ —â–µ –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ –∫–æ–¥. –ó–≥–µ–Ω–µ—Ä—É–π –∫–ª—é—á –≤ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ.", false);
      return;
    }
    if(String(u.lastKey).trim() !== key){
      setMsg("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –∫–æ–¥.", false);
      return;
    }

    // OK
    saveSession(email, key);
    applyUserState(u, key);

    setMsg("–£—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥ ‚úÖ", true);
    setTimeout(()=>unlock(u.nick), 150);
  }

  function tryAutoLogin(){
    const s = getSession();
    if(!s){ lock(); return; }

    emailEl.value = s.email;
    keyEl.value = s.key;

    const db = loadDB();
    const u = findUserByEmail(db, s.email);
    if(!u){ clearSession(); lock(); return; }

    if(u.banned){
      const reason = u.banReason || u.reason || u.bannedReason || "–ü—Ä–∏—á–∏–Ω—É –Ω–µ –≤–∫–∞–∑–∞–Ω–æ.";
      showBan(reason);
      return;
    }

    if(!u.lastKey || String(u.lastKey).trim() !== String(s.key).trim()){
      clearSession();
      lock();
      return;
    }

    applyUserState(u, s.key);
    unlock(u.nick);
  }

  // UI events
  loginBtn.addEventListener("click", doLogin);
  keyEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
  emailEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

  reloadBtn.addEventListener("click", ()=>location.reload());

  banLogoutBtn.addEventListener("click", ()=>{
    clearSession();
    banOverlay.style.display = "none";
    emailEl.value = "";
    keyEl.value = "";
    lock();
    setMsg("", true);
  });

  // –°—Ç–∞—Ä—Ç: –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π –≤—Ö—ñ–¥ (–∞–±–æ –∞–≤—Ç–æ–ª–æ–≥—ñ–Ω –ø–æ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ–π —Å–µ—Å—ñ—ó)
  tryAutoLogin();
})();
</script>


</body>
</html>
